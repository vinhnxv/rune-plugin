# Phase 7: MEND — Full Algorithm

Invoke `/rune:mend` logic on the TOME. Parallel fixers resolve findings from the code review phase.

**Team**: `arc-mend-{id}` (delegated to `/rune:mend` — manages its own TeamCreate/TeamDelete with guards)
**Tools**: Read, Write, Edit, Bash, Glob, Grep (fixers get restricted tools per mend.md)
**Timeout**: Round 0 = 23 min (PHASE_TIMEOUTS.mend), Retry rounds = 13 min (MEND_RETRY_TIMEOUT)

**Inputs**:
- TOME artifact: round 0 uses `tmp/arc/{id}/tome.md`, retry round N uses `tmp/arc/{id}/tome-round-{N}.md`
- Checkpoint convergence state (`checkpoint.convergence.round`)
- Arc identifier (`id`)

**Outputs**: `tmp/arc/{id}/resolution-report.md`

**Consumers**: Phase 7.5 (VERIFY MEND) reads the resolution report to detect regressions

## TOME Source Selection

The TOME input file varies based on the convergence round:

```javascript
const mendRound = checkpoint.convergence?.round || 0
const tomeSource = mendRound === 0
  ? `tmp/arc/${id}/tome.md`
  : `tmp/arc/${id}/tome-round-${mendRound}.md`
```

- **Round 0**: Uses the TOME produced by Phase 6 (CODE REVIEW) — full findings from Roundtable Circle review
- **Round N (retry)**: Uses a mini-TOME generated by Phase 7.5 (VERIFY MEND) containing only SPOT:FINDING regressions converted to RUNE:FINDING format

## Timeout Calculation

The mend timeout varies based on the convergence round:

```javascript
const mendTimeout = mendRound === 0 ? PHASE_TIMEOUTS.mend : MEND_RETRY_TIMEOUT

// PHASE_TIMEOUTS.mend   = 1_380_000  // 23 min (inner 15m + 5m setup + 3m ward/cross-file)
// MEND_RETRY_TIMEOUT    = 780_000    // 13 min (inner 5m polling + 5m setup + 3m ward)
```

### Inner Polling Timeout Derivation

The inner polling timeout passed to `/rune:mend` is derived from the outer phase budget minus overhead:

```javascript
// BUG FIX (v1.24.1): Propagate arc phase budget to mend's inner polling timeout.
// Without --timeout, mend always uses 15 min (standalone default) — which exceeds
// arc's retry budget (13 min) and ignores setup/teardown overhead.
// Inner polling = mendTimeout - SETUP_BUDGET - MEND_EXTRA_BUDGET (min 2 min).
const innerPolling = Math.max(mendTimeout - SETUP_BUDGET - MEND_EXTRA_BUDGET, 120_000)

// Round 0: innerPolling = 1_380_000 - 300_000 - 180_000 = 900_000 (15 min)
// Retry:   innerPolling = 780_000 - 300_000 - 180_000 = 300_000 (5 min)
// Floor:   120_000 (2 min minimum)
```

**SETUP_BUDGET** (5 min): Time for team creation, task creation, agent spawning, report generation, cleanup.
**MEND_EXTRA_BUDGET** (3 min): Additional time for ward check, cross-file mend validation, doc-consistency.

## Invocation

```javascript
updateCheckpoint({ phase: "mend", status: "in_progress", phase_sequence: 7, team_name: mendTeamName })

// Delegate to /rune:mend with arc-specific parameters:
// - TOME source path (varies by round)
// - Timeout propagation (--timeout ${mendTimeout})
// - Team name prefix: arc-mend-{id}
// Delegation pattern: /rune:mend creates its own team (e.g., rune-mend-{id}).
// Arc reads the team name from the mend state file or teammate idle notification.
const mendTeamName = Read(`tmp/.rune-mend-*.json`)?.team_name || `rune-mend-${Date.now()}`
```

## Completion and Halt Check

```javascript
const failedCount = countFindings("FAILED", resolutionReport)
updateCheckpoint({
  phase: "mend", status: failedCount > 3 ? "failed" : "completed",
  artifact: `tmp/arc/${id}/resolution-report.md`, artifact_hash: sha256(resolutionReport), phase_sequence: 7
})
```

**Halt condition**: If more than 3 findings remain in FAILED state after mend, the pipeline halts. The user must manually fix the remaining issues and run `/rune:arc --resume` to continue.

## Error Handling

| Condition | Action |
|-----------|--------|
| >3 FAILED findings | HALT pipeline. User fixes manually, then `/rune:arc --resume` |
| Mend timeout (inner polling exceeded) | Phase marked failed. Partial fixes preserved in committed code |
| No fixable findings in TOME | Mend completes with empty resolution (all findings are false positives or unfixable) |
| Team creation fails | Cleanup fallback via `rm -rf` (see team-lifecycle-guard.md) |

## Team Lifecycle

Delegated to `/rune:mend` — manages its own TeamCreate/TeamDelete with guards (see [team-lifecycle-guard.md](team-lifecycle-guard.md)). Arc records the actual `team_name` in checkpoint for cancel-arc discovery.

**Output**: `tmp/arc/{id}/resolution-report.md`

**Failure policy**: Halt if >3 FAILED findings remain. User manually fixes, runs `/rune:arc --resume`.
