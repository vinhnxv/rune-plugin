# Phase 7: MEND — Full Algorithm

Invoke `/rune:mend` logic on the TOME. Parallel fixers resolve findings from the code review phase.

**Team**: `arc-mend-{id}` (delegated to `/rune:mend` — manages its own TeamCreate/TeamDelete with guards)
**Tools**: Read, Write, Edit, Bash, Glob, Grep (fixers get restricted tools per mend.md)
**Timeout**: Round 0 = 23 min (PHASE_TIMEOUTS.mend), Retry rounds = 13 min (MEND_RETRY_TIMEOUT)

**Inputs**:
- TOME artifact: round 0 uses `tmp/arc/{id}/tome.md`, retry round N uses `tmp/arc/{id}/tome-round-{N}.md`
- Checkpoint convergence state (`checkpoint.convergence.round`)
- Arc identifier (`id`)

**Outputs**: `tmp/arc/{id}/resolution-report.md`

**Consumers**: Phase 7.5 (VERIFY MEND) reads the resolution report to detect regressions

> **Note**: `sha256()`, `updateCheckpoint()`, `exists()`, and `warn()` are dispatcher-provided utilities available in the arc orchestrator context. Phase reference files call these without import.

> **Note**: This phase may be invoked multiple times by the convergence gate (Phase 7.5). On retry, the TOME source changes to `tome-round-{N}.md` and the timeout shrinks to MEND_RETRY_TIMEOUT. See [verify-mend.md](verify-mend.md) for the convergence protocol.

## TOME Source Selection

The TOME input file varies based on the convergence round:

```javascript
const mendRound = checkpoint.convergence?.round || 0
const tomeSource = mendRound === 0
  ? `tmp/arc/${id}/tome.md`
  : `tmp/arc/${id}/tome-round-${mendRound}.md`
```

- **Round 0**: Uses the TOME produced by Phase 6 (CODE REVIEW) — full findings from Roundtable Circle review
- **Round N (retry)**: Uses a mini-TOME generated by Phase 7.5 (VERIFY MEND) containing only SPOT:FINDING regressions converted to RUNE:FINDING format

## Timeout Calculation

The mend timeout varies based on the convergence round:

```javascript
const mendTimeout = mendRound === 0 ? PHASE_TIMEOUTS.mend : MEND_RETRY_TIMEOUT

// PHASE_TIMEOUTS.mend   = 1_380_000  // 23 min (inner 15m + 5m setup + 3m ward/cross-file)
// MEND_RETRY_TIMEOUT    = 780_000    // 13 min (inner 5m polling + 5m setup + 3m ward)
```

### Inner Polling Timeout Derivation

The inner polling timeout passed to `/rune:mend` is derived from the outer phase budget minus overhead:

```javascript
// BUG FIX (v1.24.1): Propagate arc phase budget to mend's inner polling timeout.
// Without --timeout, mend always uses 15 min (standalone default) — which exceeds
// arc's retry budget (13 min) and ignores setup/teardown overhead.
// Inner polling = mendTimeout - SETUP_BUDGET - MEND_EXTRA_BUDGET (min 2 min).
const innerPolling = Math.max(mendTimeout - SETUP_BUDGET - MEND_EXTRA_BUDGET, 120_000)

// Round 0: innerPolling = 1_380_000 - 300_000 - 180_000 = 900_000 (15 min)
// Retry:   innerPolling = 780_000 - 300_000 - 180_000 = 300_000 (5 min)
// Floor:   120_000 (2 min minimum)
```

**SETUP_BUDGET** (5 min): Time for team creation, task creation, agent spawning, report generation, cleanup.
**MEND_EXTRA_BUDGET** (3 min): Additional time for ward check, cross-file mend validation, doc-consistency.

## Invocation

```javascript
// STEP 1: Read mend team name from state file (MUST happen before checkpoint update)
// Use Glob() to resolve wildcard — Read() does not support glob expansion.
// SEC-001 FIX: Filter to current session timeframe to prevent cross-session confusion
const mendStateFiles = Glob("tmp/.rune-mend-*.json").filter(f => {
  try {
    const state = JSON.parse(Read(f))
    const age = Date.now() - new Date(state.started).getTime()
    return state.status === "active" && !Number.isNaN(age) && age < PHASE_TIMEOUTS.mend
  } catch (e) { return false }
})
if (mendStateFiles.length > 1) warn(`Multiple active mend state files found (${mendStateFiles.length}) — using most recent`)
const mendTeamName = mendStateFiles.length > 0
  ? JSON.parse(Read(mendStateFiles[0])).team_name
  : `rune-mend-${Date.now()}`
// SEC-2 FIX: Validate team_name from state file before storing in checkpoint (TOCTOU defense)
if (!/^[a-zA-Z0-9_-]+$/.test(mendTeamName)) throw new Error(`Invalid team_name from state file: ${mendTeamName}`)

// STEP 2: Update checkpoint with resolved team name
updateCheckpoint({ phase: "mend", status: "in_progress", phase_sequence: 7, team_name: mendTeamName })

// STEP 3: Delegate to /rune:mend with arc-specific parameters:
// - TOME source path (varies by round)
// - Timeout propagation (--timeout ${mendTimeout})
// - Team name prefix: arc-mend-{id}
// Delegation pattern: /rune:mend creates its own team (e.g., rune-mend-{id}).
// Arc reads the team name from the mend state file or teammate idle notification.
```

## Completion and Halt Check

```javascript
const failedCount = countFindings("FAILED", resolutionReport)
updateCheckpoint({
  phase: "mend", status: failedCount > 3 ? "failed" : "completed",
  artifact: `tmp/arc/${id}/resolution-report.md`, artifact_hash: sha256(resolutionReport), phase_sequence: 7
})
```

**Halt condition**: If more than 3 findings remain in FAILED state after mend, the pipeline halts. The user must manually fix the remaining issues and run `/rune:arc --resume` to continue.

## Error Handling

| Condition | Action |
|-----------|--------|
| >3 FAILED findings | HALT pipeline. User fixes manually, then `/rune:arc --resume` |
| Mend timeout (inner polling exceeded) | Phase marked failed. Partial fixes preserved in committed code |
| No fixable findings in TOME | Mend completes with empty resolution (all findings are false positives or unfixable) |
| Team creation fails | Cleanup fallback via `rm -rf` (see team-lifecycle-guard.md) |

## Team Lifecycle

Delegated to `/rune:mend` — manages its own TeamCreate/TeamDelete with guards (see [team-lifecycle-guard.md](team-lifecycle-guard.md)). Arc records the actual `team_name` in checkpoint for cancel-arc discovery.

Arc runs `prePhaseCleanup(checkpoint)` before delegation (ARC-6). See SKILL.md Inter-Phase Cleanup Guard section.

**Output**: `tmp/arc/{id}/resolution-report.md`

**Failure policy**: Halt if >3 FAILED findings remain. User manually fixes, runs `/rune:arc --resume`.

## Crash Recovery

If this phase crashes before reaching cleanup, the following resources are orphaned:

| Resource | Location |
|----------|----------|
| Team config | `~/.claude/teams/rune-mend-{id}/` |
| Task list | `~/.claude/tasks/rune-mend-{id}/` |
| State file | `tmp/.rune-mend-*.json` (stuck in `"active"` status) |
| Signal dir | `tmp/.rune-signals/rune-mend-{id}/` |

### Recovery Layers

If this phase crashes, the orphaned resources above are recovered by the 3-layer defense:
Layer 1 (ORCH-1 resume), Layer 2 (`/rune:rest --heal`), Layer 3 (arc pre-flight stale scan).
Mend phase teams use `rune-mend-*` prefix — handled by the sub-command's own pre-create guard (not Layer 3).

See [team-lifecycle-guard.md](team-lifecycle-guard.md) §Orphan Recovery Pattern for full layer descriptions and coverage matrix.
