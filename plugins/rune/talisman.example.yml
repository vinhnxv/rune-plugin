# Rune Plugin Configuration
# Copy to .claude/talisman.yml (project-level) or ~/.claude/talisman.yml (global)
#
# Resolution order:
#   1. .claude/talisman.yml   (project, highest priority)
#   2. ~/.claude/talisman.yml (user global)
#   3. Plugin defaults           (7 built-in Ashes)

version: 1

# ──────────────────────────────────────────────
# Cost Tier — Agent model selection
# ──────────────────────────────────────────────
# Controls which Claude model each agent category uses when spawned.
# One switch, four profiles:
#   opus     — Maximum quality, all agents on strongest model (~100% cost)
#   balanced — Strategic mix: truth-tellers on Opus, others on Sonnet/Haiku (~35-40% cost) [default]
#   efficient — Save money: Sonnet primary, Haiku for mechanical tasks (~20-25% cost)
#   minimal  — Maximum savings: Haiku for most, Sonnet for reasoning-heavy (~15-20% cost)
# See references/cost-tier-mapping.md for full agent-to-category-to-model mapping.
# Does NOT affect: main session model, Custom Ashes, or Codex Oracle.
# cost_tier: balanced    # Omit or comment out to use "balanced" (the default)

# ──────────────────────────────────────────────
# Rune Gaze — File classification overrides
# ──────────────────────────────────────────────
rune-gaze:
  # Override which extensions map to backend Ash (Forge Warden)
  backend_extensions:
    - .py
    - .go
    - .rs
    - .rb

  # Override which extensions map to frontend Ash (Glyph Scribe)
  frontend_extensions:
    - .tsx
    - .ts
    - .jsx

  # Override which extensions map to infrastructure (Forge Warden)
  # Subset shown — see rune-gaze.md for all defaults (.sh, .bash, .zsh, .sql, .tf, .hcl, .tfvars, .dockerfile)
  # infra_extensions:
  #   - .tf
  #   - .sh
  #   - .sql

  # Override which extensions map to config (Forge Warden)
  # Subset shown — see rune-gaze.md for all defaults (.yml, .yaml, .json, .toml, .ini, .cfg, .conf, .env.example, .env.template)
  # config_extensions:
  #   - .yml
  #   - .yaml
  #   - .json
  #   - .toml

  # Min lines changed to summon Knowledge Keeper for doc files (default: 10)
  # doc_line_threshold: 10

  # Files/patterns to skip entirely (glob syntax)
  skip_patterns:
    - "**/migrations/**"
    - "**/*.generated.ts"
    - "**/vendor/**"

  # Files that should always be reviewed regardless of extension
  always_review:
    - "CLAUDE.md"
    - ".claude/**/*.md"

# ──────────────────────────────────────────────
# Custom Ashes — Extend the built-in 7
# ──────────────────────────────────────────────
# Each custom Ash joins the Roundtable Circle lifecycle:
#   - Gets a Truthbinding wrapper prompt (evidence, Seal, Glyph Budget)
#   - Participates in dedup via its unique finding_prefix
#   - Verified by Truthsight (if enabled)
#   - Findings aggregated into TOME.md
#
# Agent sources:
#   local  → .claude/agents/{name}.md (project-level)
#   global → ~/.claude/agents/{name}.md (user-level)
#   plugin → Full namespace like "my-plugin:review:agent-name"

ashes:
  custom:
    # Example 1: A local project-specific reviewer
    # Add 'forge' to workflows to enable Forge Gaze matching (see Example 3)
    - name: "domain-logic-reviewer"
      agent: "domain-logic-reviewer"       # Resolves to .claude/agents/domain-logic-reviewer.md
      source: local
      workflows: [review, audit]
      trigger:
        extensions: [".py", ".rb", ".go"]
        paths: ["src/domain/", "src/services/", "app/models/"]
      context_budget: 20
      finding_prefix: "DOM"
      required_sections:
        - "P1 (Critical)"
        - "P2 (High)"
        - "P3 (Medium)"
        - "Reviewer Assumptions"
        - "Self-Review Log"

    # Example 2: A global user-level performance agent
    - name: "perf-deep-scan"
      agent: "perf-deep-scan"              # Resolves to ~/.claude/agents/perf-deep-scan.md
      source: global
      workflows: [audit]                   # Audit only (too heavy for PR reviews)
      trigger:
        extensions: [".py", ".ts", ".tsx", ".rb"]
        min_files: 10                      # Only summon if 10+ matching files
      context_budget: 20
      finding_prefix: "PERF"

    # Example 3: A review + forge agent (participates in all workflows)
    # Forge is default in /rune:devise and /rune:forge — custom agents participate
    # via topic matching when "forge" is in their workflows list.
    - name: "api-contract-reviewer"
      agent: "api-contract-reviewer"       # Resolves to .claude/agents/api-contract-reviewer.md
      source: local
      workflows: [review, audit, forge]    # "forge" enables Forge Gaze topic matching
      trigger:
        extensions: [".py", ".ts"]         # For review/audit (file-based matching)
        paths: ["src/api/", "api/"]
        topics: [api, contract, endpoints, rest, graphql]  # For forge (topic-based matching)
      forge:                               # Required when "forge" is in workflows
        subsection: "API Contract Analysis"
        perspective: "API design, contract compatibility, and endpoint patterns"
        budget: enrichment                 # "enrichment" (lightweight) or "research" (web search)
      context_budget: 15
      finding_prefix: "API"

    # Example 4: An agent from another installed plugin
    # SECURITY: Cross-plugin agents are resolved by namespace prefix.
    # The agent name must match `{plugin}:{category}:{agent}` exactly.
    # Path traversal (../) in agent names is rejected at load time.
    # - name: "compliance-checker"
    #   agent: "my-plugin:review:compliance-checker"
    #   source: plugin
    #   workflows: [review, audit]
    #   trigger:
    #     extensions: ["*"]                # All file types
    #     paths: ["src/api/", "src/auth/"]
    #   context_budget: 15
    #   finding_prefix: "COMP"

    # Example 5: Persona-based reviewer (v1.88.0+)
    # Use the built-in senior-engineer-reviewer agent as an opinionated persona Ash.
    # Custom personas use the same ashes.custom[] framework — no separate namespace needed.
    # - name: "senior-engineer"
    #   agent: "rune:review:senior-engineer-reviewer"
    #   source: plugin
    #   workflows: [review]
    #   finding_prefix: "SENIOR"

    # Example 6: CLI-backed Ash — external model via CLI (v1.57.0+)
    # When `cli:` is present, the Ash invokes an external model via CLI
    # instead of a Claude Code agent. Detected via detectExternalModel().
    # `agent` and `source` become optional (ignored when cli: is set).
    # Subject to max_cli_ashes sub-cap (default: 2).
    # - name: "gemini-oracle"
    #   cli: "gemini"                      # CLI binary name (must match CLI_BINARY_PATTERN)
    #   model: "gemini-2.5-pro"            # Model name (must match model_pattern)
    #   output_format: "json"              # jsonl | text | json
    #   finding_prefix: "GEM"              # Unique 2-5 uppercase prefix
    #   timeout: 300                       # CLI timeout in seconds (300-3600, default: 300)
    #   ignore_file: ".geminiignore"       # Optional ignore file
    #   detection_steps: ["version_check"] # Optional: version_check, auth_check, jq_check, ignore_file_check
    #   model_pattern: "^gemini-"          # Optional regex to validate model name (default: MODEL_NAME_PATTERN)
    #   workflows: [review, audit]
    #   trigger:
    #     always: true                     # Always summon (skip file matching)
    #   context_budget: 20

# ──────────────────────────────────────────────
# Settings — Global behavior adjustments
# ──────────────────────────────────────────────
settings:
  # Hard cap on total Ash (built-in + custom)
  # Max recommended: 9 (verifier context budget constraint)
  max_ashes: 9

  # Sub-cap on CLI-backed Ashes (v1.57.0+)
  # Must be <= max_ashes. Codex Oracle is NOT counted toward this limit.
  # CLI-backed Ashes are external models invoked via CLI (e.g., gemini, llama).
  # Set to 0 to disable all CLI-backed Ashes.
  max_cli_ashes: 2

  # Extended dedup hierarchy — higher = wins on conflict
  # Must include ALL active prefixes (built-in + custom)
  # Built-in prefixes: SEC, BACK, VEIL, DOUBT, PY, TSR, RST, PHP, FAPI, DJG, LARV, SQLA, TDD, DDD, DI, DOC, QUAL, FRONT, CDX
  dedup_hierarchy:
    - SEC          # Ward Sentinel (always highest)
    - BACK         # Forge Warden
    - VEIL         # Veil Piercer (truth-telling)
    - DOUBT        # Doubt Seer (meta-findings, non-deduplicable)
    - PY           # Python Reviewer (stack specialist, v1.86.0+)
    - TSR          # TypeScript Reviewer (stack specialist, v1.86.0+)
    - RST          # Rust Reviewer (stack specialist, v1.86.0+)
    - PHP          # PHP Reviewer (stack specialist, v1.86.0+)
    - FAPI         # FastAPI Reviewer (stack specialist, v1.86.0+)
    - DJG          # Django Reviewer (stack specialist, v1.86.0+)
    - LARV         # Laravel Reviewer (stack specialist, v1.86.0+)
    - SQLA         # SQLAlchemy Reviewer (stack specialist, v1.86.0+)
    - TDD          # TDD Compliance Reviewer (stack specialist, v1.86.0+)
    - DDD          # DDD Reviewer (stack specialist, v1.86.0+)
    - DI           # DI Reviewer (stack specialist, v1.86.0+)
    - API          # Custom: api-contract-reviewer
    - DOM          # Custom: domain-logic-reviewer
    - PERF         # Custom: perf-deep-scan
    - DOC          # Knowledge Keeper
    - QUAL         # Pattern Weaver
    - FRONT        # Glyph Scribe
    - CDX          # Codex Oracle (lowest — cross-model findings defer to all built-in Ashes)

  # Whether Truthsight Layer 2 verifier checks custom Ash outputs
  verification:
    layer_2_custom_agents: true
  # NOTE: Enforcement Asymmetry config is in the review: convergence section below.
  # See review: → enforcement_asymmetry: (line ~652) or agents/review/references/enforcement-asymmetry.md

# ── Deep Audit settings (v1.56.0+) ──────────────
# Deep investigation teammates for /rune:audit --deep.
# Runs a second Roundtable Circle pass with 4 investigation Ashes
# after the standard audit completes.
audit:
  deep:
    enabled: true
    ashes:
      - rot-seeker
      - strand-tracer
      - decree-auditor
      - fringe-watcher
    max_deep_ashes: 4
    timeout_multiplier: 1.5
    dimensions:                      # Select which dimensions to run (default: all 7)
      - truth-seeker                 # Correctness (CORR)
      - ruin-watcher                 # Failure Modes (FAIL)
      - breach-hunter                # Security-deep (DSEC)
      - order-auditor                # Design (DSGN)
      - ember-seer                   # Performance (RSRC)
      - signal-watcher               # Observability (OBSV)
      - decay-tracer                 # Maintainability (MTNB)
    max_dimension_agents: 7          # Cap on dimension agents per pass (1-8)
  always_deep: false              # When true, all audits run deep pass without --deep flag
  # audit_mend: Removed in v1.67.0 (audit phases unified into Phase 6 --deep)

  # ── Incremental Stateful Audit (v1.84.0+) ──────
  # Opt-in incremental auditing with persistent state, priority scoring,
  # and 3-tier coverage tracking (file, workflow, API).
  # Activated via --incremental flag. Default /rune:audit behavior unchanged.
  # incremental:
  #   enabled: true                        # Feature gate (default: false — opt-in)
  #   batch_size: 30                       # Files per batch (10-100, default: 30)
  #   min_batch_size: 10                   # Minimum batch size (default: 10)
  #   weights:                             # Priority scoring weights (must sum to 1.0)
  #     staleness: 0.30                    # Days since last audit
  #     recency: 0.25                      # Inverse days since last git modification
  #     risk: 0.20                         # From Lore Layer risk-map.json
  #     complexity: 0.10                   # Line count normalized
  #     novelty: 0.10                      # File creation recency
  #     role: 0.05                         # File role heuristic
  #   always_audit:                        # Glob patterns always included in every batch
  #     - "CLAUDE.md"
  #     - ".claude/**/*.md"
  #     - "**/auth/**"
  #   extra_skip_patterns:                 # Additional exclusions beyond .gitignore
  #     - "**/generated/**"
  #     - "**/*.snapshot.*"
  #   coverage_target: 0.80               # Reporting threshold (0.0-1.0)
  #   staleness_window_days: 90           # Days before an audit is considered stale
  #   version_controlled: false           # Track audit state in git (default: gitignored)
  #   max_history_sessions: 50            # Session snapshots to retain
  #   tiers:
  #     workflows:
  #       enabled: true                    # Enable Tier 2 workflow audit
  #       max_per_batch: 3                 # Max workflows per audit session
  #       discovery_methods:               # Which discovery methods to use
  #         - "import-graph"
  #         - "route-handler"
  #         - "convention"
  #     apis:
  #       enabled: true                    # Enable Tier 3 API audit
  #       max_per_batch: 5                 # Max API endpoints per audit session
  #       frameworks:                      # Hint for framework-specific detection
  #         - "express"
  #         - "fastapi"

  # ── Directory Scoping (v1.91.0+) ──────────────
  # Restrict audit to one or more directories instead of scanning the whole repo.
  # Equivalent to passing --dirs on the CLI; talisman sets the project default.
  # Glob patterns (relative to repo root). Accepts a single string or a list.
  # dirs:
  #   - "src/"                             # Audit only the src/ tree (default: null = full repo)
  #   - "lib/"                             # Add additional directories as needed
  # exclude_dirs:
  #   - "vendor/"                          # Exclude these directories (merged with --exclude-dirs flag)

  # ── Custom Prompt Override (v1.91.0+) ─────────
  # Load a Markdown file as an additional system-level instruction injected into
  # every Ash prompt during this audit. Useful for project-specific audit focus.
  # default_prompt_file: ".claude/prompts/audit-focus.md"  # Path to prompt file (relative to repo root)

# ──────────────────────────────────────────────
# Defaults — Disable built-in Ash
# ──────────────────────────────────────────────
# Use this to turn off a built-in Ash you've replaced with a custom one
defaults:
  disable_ashes: []
  # Example: disable_ashes: ["knowledge-keeper", "veil-piercer"]
  # Valid names: forge-warden, ward-sentinel, veil-piercer, pattern-weaver, glyph-scribe, knowledge-keeper, codex-oracle

# ──────────────────────────────────────────────
# Forge — Forge Gaze selection overrides (forge runs by default)
# ──────────────────────────────────────────────
# Forge enrichment is enabled by default in /rune:devise and /rune:forge.
# Use --quick with /rune:devise to skip forge, or --exhaustive for deeper research.
# forge:
#   threshold: 0.30          # Score threshold for agent selection (0.0-1.0)
#   max_per_section: 3       # Max agents per plan section (upper bound: 5)
#   max_total_agents: 8      # Max total agents across all sections (upper bound: 15)
#   stack_affinity_bonus: 0.2  # Score bonus for agents matching detected stack (v1.86.0+)

# ──────────────────────────────────────────────
# Plan — Verification gate patterns
# ──────────────────────────────────────────────
# Custom patterns for the plan verification gate (Phase 4B.5).
# Each pattern runs with zero LLM hallucination risk (deterministic grep).
# plan:
#   verification_patterns:
#     # Each pattern may include a `phase` field — an array of pipeline phases
#     # when this check should run. Valid values: "plan", "post-work", "pre-review", "arc"
#     # If `phase` is omitted, defaults to ["plan"] (backward-compatible).
#     - regex: '"11 commands"'
#       paths: "plugins/rune/ .claude-plugin/"
#       exclusions: "--glob '!commands/plan.md'"
#       expect_zero: true
#       description: "Command count updated to 12"
#       phase: ["plan"]                    # Only during planning (default behavior)
#     - regex: '"--skip-forge"'
#       paths: "plugins/rune/"
#       exclusions: "--glob '!commands/plan.md' --glob '!CHANGELOG.md'"
#       expect_zero: true
#       description: "Flag renamed to --no-forge"
#       phase: ["plan", "post-work"]       # Check during plan AND after work completes
#     # Example: a check that only runs post-work (not during planning)
#     # - regex: 'TODO\(v1\.16\)'
#     #   paths: "plugins/rune/"
#     #   expect_zero: true
#     #   description: "All v1.16 TODOs resolved"
#     #   phase: ["post-work", "pre-review"]  # Only after implementation

# ──────────────────────────────────────────────
# Plan — Freshness gate (v1.26.0+)
# ──────────────────────────────────────────────
# Pre-flight check in /rune:arc that detects when a plan's
# source codebase has drifted significantly since plan creation.
# Requires git_sha in plan frontmatter (added by /rune:devise v1.26.0+).
# Plans without git_sha gracefully skip the check.
#
# NOTE: These settings go under the same `plan:` key as verification_patterns above.
# In your talisman.yml, merge both blocks under a single `plan:` key:
#   plan:
#     verification_patterns: [...]
#     freshness:
#       enabled: true
#       ...
#
#   plan.freshness:
#     enabled: true              # Set false to disable freshness check globally
#     warn_threshold: 0.7        # Score below this → WARN (float, 0.01-1.0)
#     block_threshold: 0.4       # Score below this → STALE (float, 0.0-0.99, must be < warn)
#                                # Note: block_threshold can be 0.0 (disables blocking).
#                                # warn_threshold minimum is 0.01 — to disable warnings entirely,
#                                # set enabled: false instead.
#     max_commit_distance: 100   # Commits beyond this → max drift signal (clamped 1-10000)

# ──────────────────────────────────────────────
# Inspect — Plan-vs-implementation audit (v1.50.0+)
# ──────────────────────────────────────────────
# /rune:inspect compares a plan against the codebase to measure
# implementation completeness, quality, and gaps.
inspect:
  max_inspectors: 4            # Default inspector count for standalone
  completion_threshold: 80     # READY verdict threshold
  gap_threshold: 20            # CRITICAL_ISSUES threshold
  max_fixes: 20                # --fix cap (standalone)
  fix_timeout: 600000          # --fix timeout (standalone)

# ──────────────────────────────────────────────
# Arc — Default flag overrides (v1.40.0+)
# ──────────────────────────────────────────────
# 3-layer priority chain: hardcoded defaults → talisman.yml → CLI flags.
# CLI flags always win. Talisman provides per-project defaults.
# Hardcoded defaults (used when talisman omits the key):
#   no_forge: false, approve: false, skip_freshness: false, confirm: false
arc:
  defaults:
    no_forge: false              # Skip forge enrichment (CLI: --no-forge)
    approve: false               # Require human approval per task (CLI: --approve)
    skip_freshness: false        # Bypass plan freshness check (CLI: --skip-freshness)
    confirm: false               # Pause for confirmation between phases (CLI: --confirm)

  # ── Shard Execution (v1.66.0+) ─────────────
  # Controls shard-aware behavior in arc and arc-batch.
  # Shard plans are detected via -shard-N- filename regex.
  sharding:
    enabled: true                # Master toggle for all shard awareness (default: true)
    auto_sort: true              # Auto-sort shards by number in arc-batch (default: true)
    exclude_parent: true         # Auto-exclude parent plans with shattered: true (default: true)
    prerequisite_check: true     # Verify prerequisite shards before arc run (default: true)
    shared_branch: true          # Share feature branch across shards (default: true)

  # ── Ship settings (Phase 9) ────────────────
  # Controls PR creation after audit passes.
  ship:
    auto_pr: true                # Create PR automatically (CLI: --no-pr to disable)
    auto_merge: false            # Merge PR automatically after CI (CLI: --no-merge to disable)
    merge_strategy: "squash"     # squash | merge | rebase (default: squash)
    wait_ci: false               # Wait for CI checks before merge (default: false)
    draft: false                 # Create PR as draft (CLI: --draft)
    labels: []                   # Labels to apply to PR (e.g., ["rune", "auto-merge"])
    pr_monitoring: false         # Include post-deploy monitoring section in PR body
    rebase_before_merge: true    # Rebase onto target branch before merge (default: true)

    # ── Bot Review (Phase 9.1 + 9.2, v1.88.0+) ──────
    # Controls bot review wait and PR comment resolution after PR creation.
    # Disabled by default — opt-in via enabled: true or --bot-review CLI flag.
    # bot_review:
    #   enabled: false                   # Master toggle for Phase 9.1 + 9.2 (default: false — opt-in)
    #   timeout_ms: 900000              # 15 min hard timeout for bot review wait (default: 900000)
    #   initial_wait_ms: 120000         # 2 min initial wait for bots to start (default: 120000)
    #   poll_interval_ms: 30000         # 30s between polls (default: 30000)
    #   stability_window_ms: 120000     # 2 min of no new bot activity = done (default: 120000)
    #   max_comment_batch_size: 10      # Process comments in batches of N (default: 10)
    #   auto_resolve_outdated: true     # Auto-resolve outdated review threads (default: true)
    #   hallucination_check: true       # Verify bot findings against actual code (default: true)
    #   known_bots:                     # List of known review bot usernames
    #     - "gemini-code-assist[bot]"
    #     - "coderabbitai[bot]"
    #     - "copilot[bot]"
    #     - "cubic-dev-ai[bot]"
    #     - "chatgpt-codex-connector[bot]"
    #   quality_commands: []            # Project-specific quality check commands
    #   # Example: ["npm run lint", "npm run typecheck"]
    #   max_review_rounds: 3           # Max bot review→fix→push cycles (default: 3)

  # ── Pre-merge checklist (Phase 9.5) ────────
  # Deterministic checks before merge. Each boolean toggles a check.
  pre_merge_checks:
    migration_conflict: true     # Check for migration file conflicts
    schema_conflict: true        # Check for schema drift
    lock_file_conflict: true     # Check for lock file conflicts (package-lock.json, yarn.lock, etc.)
    uncommitted_changes: true    # Check for uncommitted changes
    migration_paths: []          # Additional paths to scan for migration conflicts (e.g., ["db/migrate/", "alembic/versions/"])

  # ── Batch settings (v1.42.0+, talisman support v1.49.0+) ──
  # Per-plan and batch-level limits for /rune:arc-batch.
  # 3-layer priority: hardcoded defaults → talisman.yml → (future CLI flags).
  batch:
    auto_merge: true           # Auto-merge PRs after each arc run (default: true, CLI --no-merge overrides)
    max_retries: 3             # Retry count per plan (default: 3, range: 1-10)
    max_budget: 15.0           # Max budget per arc run in USD (default: 15.0, range: 1.0-100.0)
    max_turns: 200             # Max turns per arc run (default: 200, range: 50-1000)
    total_budget: null         # Total batch budget in USD (default: null = no limit, range: 1.0-500.0)
    total_timeout: null        # Total batch timeout in ms (default: null = no limit)
    stop_on_divergence: false  # Stop batch if main diverges between runs (default: false)

    # Inter-iteration summaries (v1.72.0)
    # Write structured summary files between arc iterations for
    # improved compact recovery and inter-arc context awareness.
    summaries:
      enabled: true              # Kill switch — set false to disable all summary behavior (default: true)
      # max_content_lines: 30   # Reserved — currently hardcoded
      # dir: tmp/arc-batch/summaries  # Reserved — currently hardcoded

  # ── Gap Analysis settings (v1.51.0+) ──
  gap_analysis:
    inspectors: 2              # Number (1-4): spawn first N from priority list (grace-warden > ruin-prophet > sight-oracle > vigil-keeper). Or array of names: ["grace-warden", "ruin-prophet", "sight-oracle", "vigil-keeper"]
    halt_threshold: 50         # Score below this → halt or remediate (0-100)
    # halt_on_critical: false   # Halt pipeline on critical gap failures (default: false)
    remediation:
      enabled: true            # Enable auto-fix of FIXABLE gaps
      max_fixes: 20            # Cap on fixable gaps per run
      timeout: 600000          # 10 min inner timeout

  # ── Per-phase timeout overrides (v1.12.0+, activated v1.40.0) ──
  # Values in milliseconds. Per-phase budgets feed calculateDynamicTimeout().
  timeouts:
    forge: 900000                # 15 minutes (default: inner 10m + 5m setup)
    plan_review: 900000          # 15 minutes (default: inner 10m + 5m setup)
    plan_refine: 180000          # 3 minutes (default, orchestrator-only)
    verification: 30000          # 30 seconds (default, orchestrator-only, deterministic)
    work: 2100000                # 35 minutes (default: inner 30m + 5m setup)
    gap_analysis: 720000         # 12 minutes (default, enhanced with Inspector Ashes)
    gap_remediation: 900000      # 15 minutes (new phase — gap auto-fix team)
    code_review: 900000          # 15 minutes (default: inner 10m + 5m setup)
    mend: 1380000                # 23 minutes (default: inner 15m + 5m setup + 3m ward)
    verify_mend: 240000          # 4 minutes (default, orchestrator-only)
    audit: 1200000               # 20 minutes (default: inner 15m + 5m setup)
    semantic_verification: 180000  # 3 minutes (default, v1.39.0+)
    codex_gap_analysis: 660000   # 11 minutes (default, v1.39.0+)
    test: 900000                 # 15 minutes (default, v1.43.0+; 40 min with E2E: 2_400_000)
    goldmask_verification: 900000  # 15 minutes (default, v1.47.0+)
    goldmask_correlation: 60000    # 1 minute (default, v1.47.0+)
    ship: 300000                 # 5 minutes (default, v1.40.0+)
    bot_review_wait: 900000      # 15 min (default, v1.88.0+; only when bot_review.enabled)
    pr_comment_resolution: 1200000  # 20 min (default, v1.88.0+; only when bot_review.enabled)
    merge: 600000                # 10 minutes (default, v1.40.0+)
    # NOTE: Total pipeline timeout is computed dynamically by calculateDynamicTimeout(tier).
    # It is NOT configurable via talisman. See SKILL.md for the formula.

# ──────────────────────────────────────────────
# Arc — Convergence loop settings (v1.37.0+)
# ──────────────────────────────────────────────
# Adaptive review-mend convergence loop in /rune:arc (Phase 7.5).
# The arc pipeline repeats code review → mend cycles until findings converge.
# Tier selection (LIGHT/STANDARD/THOROUGH) is automatic based on changeset size
# and risk signals, but can be overridden here.
#
# NOTE: These keys use the `arc_` prefix to avoid collision with the standalone
# review convergence keys above (convergence_enabled, convergence_tier_override, etc.).
# Arc convergence controls the Phase 6→7→7.5 loop; review convergence controls
# per-chunk convergence within a single Phase 6 invocation.
#
# NOTE: Arc convergence keys belong under the `review:` section below.
# The code reads from config.review.arc_convergence_* (not config.arc.*).
# See the `review:` section for the actual commented-out keys:
#   arc_convergence_tier_override, arc_convergence_max_cycles,
#   arc_convergence_finding_threshold, arc_convergence_improvement_ratio

# ──────────────────────────────────────────────
# Solution Arena — Competitive solution evaluation (v1.24.0+)
# ──────────────────────────────────────────────
# Phase 1.8 in /rune:devise — generates 2-5 alternative solutions and
# evaluates them via Devil's Advocate + Innovation Scout challengers.
# Weighted decision matrix selects the champion approach.
# Arena runs by default. Use --no-arena to skip, or disable globally below.
solution_arena:
  enabled: true                      # Set false to disable Arena globally
  skip_for_types: ["fix"]           # Feature types that skip Arena (fix = simple bug fixes)
  # Additional config (weights, thresholds) available in future versions

# ──────────────────────────────────────────────
# Deployment Verification — Artifact generation (v1.88.0+)
# ──────────────────────────────────────────────
# Generates Go/No-Go checklists, SQL verification queries, rollback
# procedures, and monitoring plans. Standalone utility — not integrated
# into the arc pipeline. Invoke manually after code review passes.
# deployment_verification:
#   enabled: false                     # Opt-in (not all projects need deployment artifacts)
#   auto_run_on_migrations: false      # Auto-trigger when migrations detected in diff
#   output_dir: "tmp/deploy/"          # Directory for generated artifacts
#   monitoring_stack: null             # Override detection: "datadog" | "prometheus" | "newrelic" | "sentry" | null (auto-detect)

# ──────────────────────────────────────────────
# Schema Drift Detection — Migration/model consistency (v1.89.0+)
# ──────────────────────────────────────────────
# The schema-drift-detector agent cross-references schema files against migrations
# to catch accidental branch-hopping contamination. Supports 8 migration frameworks.
# schema_drift:
#   enabled: true                      # Master toggle
#   frameworks: []                     # Auto-detect by default. Override: ["rails", "django", "alembic", "prisma", "typeorm", "knex", "drizzle", "flyway"]
#   strict_mode: false                 # When true, flags ANY schema change without a corresponding migration
#   ignore_paths: []                   # Glob patterns to exclude from drift detection

# ──────────────────────────────────────────────
# Elicitation — Structured reasoning agent (v1.31.0+)
# ──────────────────────────────────────────────
# The elicitation-sage is summoned in plan, forge, review, and mend phases
# to apply structured reasoning methods (Tree of Thoughts,
# Pre-mortem, Red Team, 5 Whys, etc.).
# Set enabled: false to disable all sage invocations without reverting code.
elicitation:
  enabled: true                    # Set false to disable all sage invocations globally

# ──────────────────────────────────────────────
# Echoes — Memory persistence
# ──────────────────────────────────────────────
echoes:
  version_controlled: false    # Set true to track .claude/echoes/ in git

  # ── Scoring — Composite re-ranking (v1.81.0+) ──
  # 5-factor composite scoring blends BM25 relevance with importance, recency,
  # file proximity, and access frequency. Weights are configurable via env vars
  # (ECHO_WEIGHT_RELEVANCE, ECHO_WEIGHT_IMPORTANCE, ECHO_WEIGHT_RECENCY,
  # ECHO_WEIGHT_PROXIMITY, ECHO_WEIGHT_FREQUENCY) with defaults summing to 1.0.
  # scoring:
  #   validation_mode: false       # Set true or ECHO_VALIDATION_MODE=1 to enable dual scoring
  #                                # Runs both BM25-only and composite in parallel, logging divergence
  #                                # to tmp/.rune-signals/.echo-scoring-validation.log
  #   # Exit criteria (switch to composite-only when ALL met):
  #   #   - Kendall tau > 0.2 in < 5% of queries
  #   #   - No Etched entry drops > 0.15 in composite score
  #   #   - No original top-5 entry falls below top-20

  # ── Semantic Groups — Automatic entry clustering (v1.82.0+) ──
  # Clusters related echo entries via Jaccard similarity and single-linkage
  # clustering. Group expansion retrieves sibling entries from the same group
  # during search, with a configurable score discount.
  # semantic_groups:
  #   expansion_enabled: false       # Enable group expansion in search pipeline (default: false)
  #   discount: 0.7                  # Composite score discount for expanded entries (0.0-1.0, default: 0.7)
  #   max_expansion: 5               # Max additional entries from group expansion (default: 5)

  # ── Query Decomposition — Multi-facet BM25 search (v1.82.0+) ──
  # Uses an LLM subprocess (claude CLI) to decompose complex queries into
  # 1-4 keyword-rich facets. Each facet runs a separate BM25 search; results
  # are merged by best score. Simple queries (<=3 non-stopword tokens) bypass
  # decomposition automatically. 3-second timeout with fallback.
  # decomposition:
  #   enabled: false                 # Enable query decomposition (default: false)

  # ── Failed Entry Retry — Token fingerprint matching (v1.82.0+) ──
  # Tracks queries that returned zero results and injects previously-failed
  # entries into future searches with matching token fingerprints. Entries
  # that later match successfully have their failure records cleared.
  # retry:
  #   enabled: false                 # Enable retry injection in search pipeline (default: false)

  # ── Haiku Reranking — Semantic re-scoring (v1.82.0+) ──
  # Uses Claude Haiku (via claude CLI subprocess) to re-score BM25 results
  # by semantic relevance. Only activates when result count exceeds threshold.
  # 4-second timeout with fallback to BM25 order.
  # reranking:
  #   enabled: false                 # Enable Haiku reranking (default: false)
  #   threshold: 25                  # Min BM25 results before reranking kicks in (default: 25)
  #   max_candidates: 40             # Cost cap — max entries sent to Haiku (default: 40)
  #   timeout: 4                     # Subprocess timeout in seconds (default: 4)

# ──────────────────────────────────────────────
# Review — Context Intelligence, Linter Awareness, and convergence (v1.35.0+)
# ──────────────────────────────────────────────
# review:                                # Uncomment this line AND the desired child keys below to enable review settings.
  #
  # Context Intelligence (Phase 0.3, v1.60.0+)
  # Gathers PR metadata and linked issue context for ash-prompt injection.
  # Requires `gh` CLI installed and authenticated.
  # context_intelligence:
  #   enabled: true                    # Default: true. Set false to skip Phase 0.3.
  #   scope_warning_threshold: 1000    # Lines changed. Warn above this. Range: 50-10000. Default: 1000.
  #   fetch_linked_issues: true        # Fetch linked issue body. Default: true.
  #   max_pr_body_chars: 3000          # Sanitized PR body cap. Range: 500-5000. Default: 3000.
  #
  # Linter Awareness (Phase 0.4, v1.60.0+)
  # Detects project linters from config files and suppresses duplicate findings.
  # No linter execution — only config file presence detection.
  # linter_awareness:
  #   enabled: true                    # Default: true. Set false to skip Phase 0.4.
  #   always_review:                   # Categories to review even if linter covers them
  #     - type-checking                # Example: still review types even with mypy
  #
  # Auto-mend: invoke /rune:mend automatically after review completes (v1.38.0+)
  # When enabled, skips the post-review AskUserQuestion and pipes the TOME
  # directly into the mend pipeline. Only triggers when P1/P2 findings exist.
  # Also activatable per-invocation via --auto-mend flag (flag overrides config).
  # auto_mend: false             # Set true to enable auto-mend globally (default: false)
  #
  # Chunked review settings (triggered when changed files exceed chunk_threshold)
  # SEC-005 FIX: Document valid ranges for numeric config values
  # chunk_threshold: 20        # Files above this trigger chunking (default: 20, range: 5-200)
  # chunk_target_size: 15      # Target files per chunk (default: 15, range: 3-50)
  # max_chunks: 5              # Circuit breaker — max chunks before redistribution (default: 5, range: 1-20)
  # cross_cutting_pass: true   # Enable cross-cutting inter-module review pass (default: true)
  # chunk_strategy: "directory" # "directory" (group by dir) | "flat" (simple split) (default: directory) [RESERVED — not yet consumed]
  # large_diff_threshold: 25   # File count triggering chunked review for standard depth (v1.51.0, default: 25, range: 5-200)
  # chunk_size: 15             # Files per chunk in chunked review mode (v1.51.0, default: 15, range: 3-50)
  #
  # Convergence loop settings (adaptive 3-tier system)
  # convergence_enabled: true              # Enable review convergence loop (default: true)
  # convergence_tier_override: null        # Force tier: "light" | "standard" | "thorough" | null (auto-detect)
  # convergence_density_threshold: 0.3     # Min findings/file for code chunks (default: 0.3)
  # convergence_evidence_threshold: 0.7    # Min findings-with-evidence ratio (default: 0.7)
  # convergence_confidence_threshold: 0.6  # Min avg confidence score (default: 0.6)
  # convergence_coverage_threshold: 0.4    # Min files-with-findings ratio for code chunks (default: 0.4)
  #
  # Arc review-mend convergence (v1.37.0+)
  # NOTE: These keys use 'arc_' prefix to distinguish from chunked review keys above.
  # Arc convergence controls the Phase 6→7→7.5 loop; review convergence controls
  # per-chunk convergence within a single Phase 6 invocation.
  # Enforcement Asymmetry (v1.88.0+)
  # Applies variable strictness based on change context (new file vs edit, shared vs isolated).
  # See agents/review/references/enforcement-asymmetry.md for full protocol.
  # enforcement_asymmetry:
  #   enabled: true                    # Master toggle (default: true)
  #   security_always_strict: true     # Cannot be disabled
  #   new_file_threshold: 0.30         # % lines changed to classify as MAJOR_EDIT (default: 0.30, range: 0.10-0.90)
  #   high_risk_import_count: 5        # Files imported by >N = HIGH risk (default: 5, range: 1-50)
  #   high_risk_paths:                 # Glob patterns for HIGH risk directories
  #     - "core/**"
  #     - "shared/**"
  #     - "lib/**"
  #     - "common/**"
  #
  # arc_convergence_tier_override: null     # Force: "light" | "standard" | "thorough" | null (auto-detect)
  # arc_convergence_max_cycles: null        # Hard override: 1-5 (overrides tier, use sparingly)
  # arc_convergence_min_cycles: null        # Min re-review cycles before convergence (1-maxCycles, default: tier-based LIGHT:1/STANDARD:2/THOROUGH:2)
  # arc_convergence_finding_threshold: 0    # P1 findings below this count = converged (default: 0)
  # arc_convergence_p2_threshold: 0         # P2 findings below this count = eligible for convergence (default: 0 = any P2 blocks)
  # arc_convergence_improvement_ratio: 0.5  # Findings must decrease by this ratio to continue (default: 0.5)
  #
  # Diff-scope tagging (v1.38.0+)
  # Generates line-level diff ranges from git, enriches inscription.json so Ashes know
  # which lines changed, and tags TOME findings as "in-diff" or "pre-existing" after
  # aggregation. Mend uses scope tags to prioritize PR-relevant findings.
  # diff_scope:
  #   enabled: true                  # Enable diff range generation and TOME tagging (default: true)
  #   expansion: 8                   # Lines of context above/below each hunk (default: 8, range: 0-50)
  #   tag_pre_existing: true         # Tag unchanged-code findings as "pre-existing" (default: true)
  #   fix_pre_existing_p1: true      # Always fix pre-existing P1 findings in mend (default: true)
  #
  # Smart convergence scoring (v1.38.0+)
  # Extends arc convergence with scope-aware composite scoring. When enabled, the
  # convergence gate evaluates finding COMPOSITION (P3 dominance, pre-existing noise)
  # rather than just raw count. Requires diff_scope.enabled: true for full benefit.
  # convergence:
  #   smart_scoring: true            # Enable smart convergence scoring (default: true)
  #   convergence_threshold: 0.7     # Score >= this = converged (default: 0.7, range: 0.1-1.0)
  #   # QUAL-011: p3_dominance_threshold and noise_threshold removed — they had no effect in v1.38.0.
  #   # Per-component thresholds are planned for a future release. Current hardcoded weights: P3=0.4, preExisting=0.3, trend=0.2, base=0.1

# ──────────────────────────────────────────────
# Mend — Parallel finding resolution settings (v1.51.0+)
# ──────────────────────────────────────────────
mend:
  cross_file_batch_size: 4     # Max files per batch in cross-file mend Phase 5.5 (v1.51.0, default: 3, range: 1-10)
                               # Controls how many files are read at once during orchestrator-only cross-file fix.
                               # Lower values reduce per-step context cost; higher values reduce round-trips.
  todos_per_fixer: 5           # Max file-todos per fixer wave (default: 5)

# ──────────────────────────────────────────────
# Review active keys — Context Pressure Defense (v1.51.0+) + Inscription Sharding (v1.98.0+)
# These keys are consumed by roundtable-circle large-diff chunked review and sharding.
# For the full commented review: block, see the # review: section above.
# ──────────────────────────────────────────────
review:
  large_diff_threshold: 25     # File count triggering chunked review for standard depth (v1.51.0)
                               # When changed files exceed this number, standard depth review
                               # switches to sequential chunk processing (default: 25, range: 5-200).
                               # NOTE: For scope=diff, sharding (below) supersedes chunking when
                               # totalFiles > shard_threshold. Chunked review only applies to scope=full.
  chunk_size: 15               # Files per chunk in chunked review mode (v1.51.0)
                               # Each chunk gets a full Ash wave; Ashes shut down between chunks
                               # to reclaim context (default: 15, range: 3-50).

  # === Inscription Sharding (v1.98.0+) ===
  # Replaces chunked review for scope=diff + standard depth when diff exceeds shard_threshold.
  # Sharding is PARALLEL vs chunking which is SEQUENTIAL — strictly faster for large diffs.
  # Domain affinity keeps related files together vs chunking's arbitrary slicing.
  # Not active in depth=deep (wave scheduling) or scope=full (audit — uses chunking).
  shard_threshold: 15          # Files above this trigger sharded review (default: 15, range: 5-50)
                               # Below threshold: standard single-pass review unchanged.
                               # Set to 999 to disable sharding entirely (escape hatch).
  shard_size: 12               # Max files per shard reviewer (default: 12, range: 5-20)
                               # Lower = fewer files per reviewer = less context pressure per agent.
                               # Higher = fewer shards = fewer agents = lower cost.
  max_shards: 5                # Maximum parallel shard reviewers (default: 5, range: 2-8)
                               # Capped at 5 to stay within SHA-SHE prefix range (3-char, 2-5 char rule).
                               # When file count requires more shards, smallest are merged first.
  cross_shard_sentinel: true   # Enable Cross-Shard Sentinel after shard reviewers complete (default: true)
                               # Sentinel reads only summary JSONs — zero source code reads.
                               # Detects naming drift, import mismatches, auth boundary gaps.
                               # Set false to skip cross-file analysis (reduces cost, reduces coverage).
  shard_model_policy: auto     # Model selection per shard (default: auto)
                               # auto       = sonnet for security/code, haiku for docs-only shards
                               # all-sonnet = force sonnet for all shards (thorough, higher cost)
                               # all-haiku  = force haiku for all shards (faster, lower cost)
  reshard_threshold: 30        # Re-review scope for convergence loop re-sharding guard (default: 30)
                               # When mend re-review scope > reshard_threshold, force standard review
                               # to preserve SHA-/SHB- finding prefix continuity across rounds.

# ──────────────────────────────────────────────
# Work — Swarm execution settings
# ──────────────────────────────────────────────
work:
  ward_commands:               # Quality gate commands for /rune:strive
    - "make check"
    - "npm test"
  max_workers: 3               # Max parallel swarm workers
  approve_timeout: 180         # Seconds to wait for task proposal approval (default: 180)
  commit_format: "rune: {subject} [ward-checked]"  # Commit message template
  skip_branch_check: false     # Skip Phase 0.5 branch/environment check (default: false)
  branch_prefix: "rune/work"   # Branch name prefix (must match /^[a-zA-Z0-9][a-zA-Z0-9._\-\/]*$/ AND must not contain '..', default: "rune/work")
  pr_monitoring: false          # Include post-deploy monitoring section in PR body (default: false)
  # pr_template: default        # Reserved for a future release — only "default" currently implemented
  # auto_push: false            # Reserved for a future release — auto-push without confirmation
  co_authors: []                # Additional Co-Authored-By lines in "Name <email>" format (default: [])
  # Example: ["Claude <noreply@anthropic.com>", "Alice <alice@example.com>"]
  todos_per_worker: 3            # Max file-todos per worker wave (default: 3)
  # consistency:                   # Doc-consistency checks for Phase 4.3 (v1.19.0+)
  #   checks: []                   # Same schema as arc.consistency.checks. If empty, falls back to arc checks, then defaults.

  # ── Hierarchical Plan Support (v1.79.0+) ──────────────
  # Controls behavior when running /rune:arc-hierarchy (parent + child plans).
  # Opt-in feature — existing strive/arc workflows are unaffected.
  # hierarchy:
  #   enabled: true                    # Enable hierarchical plan support (default: true)
  #   max_children: 12                 # Maximum children per parent plan (default: 12, range: 2-30)
  #   max_backtracks: 1               # Max backtrack attempts per child on prerequisite failure (default: 1, range: 0-3)
  #   missing_prerequisite: "pause"   # Strategy when a required artifact is missing:
  #                                   #   pause      — halt and ask user (default, safest)
  #                                   #   self-heal  — inject [SELF-HEAL] tasks to recreate the artifact
  #                                   #   backtrack  — re-run the sibling that should have provided it
  #   conflict_resolution: "pause"    # Merge conflict strategy when integrating child branch:
  #                                   #   pause      — halt and ask user (default)
  #                                   #   child-wins — accept all child branch changes
  #                                   #   feature-wins — accept all feature branch changes
  #   integration_failure: "pause"    # Strategy when post-child integration tests fail:
  #                                   #   pause      — halt and ask user (default)
  #                                   #   skip       — mark child as partial and continue
  #                                   #   retry      — retry the child arc run (once)
  #   sync_main_before_pr: true       # Merge main into feature branch before creating PR (default: true)
  #   cleanup_child_branches: true    # Delete child sub-branches after they merge to feature (default: true)
  #   require_all_children: true      # Block PR creation if any child has status failed or partial (default: true)
  #   test_timeout_ms: 300000         # Timeout for integration tests run between children (default: 300000 = 5 min)
  #   merge_strategy: "merge"         # Strategy for merging child branches into feature branch:
  #                                   #   merge  — standard merge commit (default, preserves child history)
  #                                   #   squash — squash child commits into one commit per child

# ──────────────────────────────────────────────
# Mend — Parallel finding resolution settings
# ──────────────────────────────────────────────
mend:
  todos_per_fixer: 5             # Max file-todos per fixer wave (default: 5)

# ──────────────────────────────────────────────
# File-Todos — Structured todo tracking (always active)
# ──────────────────────────────────────────────
# File-todos are generated by all Rune workflows by default.
# Use --todos=false on any command to disable for a single invocation.
file_todos:
  dir: "todos/"                  # Base directory relative to project root (default: "todos/")
  triage:
    auto_approve_p1: false       # Auto-approve P1 findings during triage (default: false)

# ──────────────────────────────────────────────
# Horizon — Strategic depth assessment (v1.47.0+)
# ──────────────────────────────────────────────
horizon:
  enabled: true                    # Kill switch — disables horizon-sage globally
  intent_default: "long-term"      # Default intent when plan lacks strategic_intent field

# ──────────────────────────────────────────────
# Testing — Arc Phase 7.7 settings (v1.43.0+)
# ──────────────────────────────────────────────
# Diff-scoped test execution in the arc pipeline.
# Unit → integration → E2E (browser) tiers, serial execution.
# Test failures are non-blocking WARNs — they do NOT halt the pipeline.
testing:
  enabled: true                    # Set false to skip Phase 7.7 globally (CLI: --no-test)
  tiers:
    unit:
      enabled: true                # Run unit tests (default: true)
      timeout_ms: 300000           # Per-suite timeout in ms (default: 300000 = 5min)
      coverage: true               # Collect coverage metrics (default: true)
    integration:
      enabled: true                # Run integration tests (default: true)
      timeout_ms: 300000           # Per-suite timeout in ms (default: 300000 = 5min)
    e2e:
      enabled: true                # Run E2E browser tests (default: true)
      timeout_ms: 300000           # Per-route timeout in ms (default: 300000 = 5min/route)
      base_url: "http://localhost:3000"  # Base URL for E2E routes
      max_routes: 3                # Cap E2E routes tested per run (default: 3)
      headed: false                # Run browser in headed mode for debugging (default: false)
  service:
    startup_command: null           # Override auto-detection (e.g., "bin/dev", "docker compose up -d")
    health_endpoint: null           # Override health check endpoint (e.g., "/api/health")
    startup_timeout: 180000         # Max wait for service readiness in ms (default: 180000 = 3min)

# ──────────────────────────────────────────────
# Inner Flame — Self-review protocol (v1.46.0+)
# ──────────────────────────────────────────────
# Universal 3-layer self-review (Grounding, Completeness, Self-Adversarial)
# for all Rune teammates. Enforced via prompt instructions + optional
# TaskCompleted hook (validate-inner-flame.sh).
# inner_flame:
#   enabled: true                  # Kill switch — disables Inner Flame prompts globally (default: true)
#   block_on_fail: false           # TaskCompleted hook exits 2 (blocking) when Self-Review Log missing (default: false = warn only)
#   confidence_floor: 60           # Prompt-enforced: teammates with post-review confidence below this report blocker instead of completing (default: 60, not hook-enforced)

# ──────────────────────────────────────────────
# Doubt Seer — Evidence quality challenger (v1.61.0+)
# ──────────────────────────────────────────────
# Cross-examines Ash findings for unsubstantiated claims.
# Runs at Phase 4.5 (after Ash monitoring, before Runebinder aggregation).
# Only spawned when enabled AND P1+P2 findings > 0.
# When disabled, evidence_coverage and unproven_claims Seal fields are absent entirely.
doubt_seer:
  enabled: false                     # Opt-in — set true to enable doubt-seer (default: false)
  workflows: [review, audit]         # Which workflows use doubt-seer (valid: review, audit, plan)
  challenge_threshold: "P2"          # Minimum severity to challenge: "P1" or "P2" (default: "P2")
  max_challenges: 20                 # Max findings to challenge per run (default: 20, range: 1-50)
  block_on_unproven: false           # VERDICT:BLOCK when unproven P1 found (default: false)
  unproven_threshold: 0.8            # Evidence ratio below this triggers CONCERN (default: 0.8, range: 0.0-1.0)

# ──────────────────────────────────────────────
# Codex Oracle — Cross-model verification (v1.18.0+)
# ──────────────────────────────────────────────
# Codex Oracle is auto-detected when the `codex` CLI is installed
# (npm install -g @openai/codex). It provides a second AI perspective
# (GPT-5.3-codex) alongside Claude's built-in Ashes, catching issues
# that single-model blind spots miss.
#
# When enabled, Codex Oracle:
#   - Joins the Roundtable Circle as a built-in Ash (CDX prefix)
#   - Runs codex exec in read-only sandbox mode
#   - Findings are verified against actual source code (Phase 5.5)
#   - Cross-validated findings (Claude + Codex agree) get a confidence boost
#   - Hallucinated findings (fabricated file/code references) are removed
#
# Prerequisites:
#   - codex CLI installed: npm install -g @openai/codex
#   - OpenAI account authenticated via codex CLI (Rune does NOT manage API keys)
#   - jq recommended for structured JSONL parsing (raw text fallback if unavailable)
#
# Disable Codex Oracle entirely by setting disabled: true.
# This is the runtime kill switch — no code changes needed.
codex:
  disabled: false                    # Set true to disable Codex Oracle entirely
  model: "gpt-5.3-codex"             # Codex model — only gpt-5.x-codex(-spark) supported (e.g., gpt-5-codex, gpt-5.3-codex, gpt-5.3-codex-spark)
  reasoning: "xhigh"                # Reasoning effort (xhigh, high, medium, low)
  # NOTE: sandbox is currently ignored — codex always uses --sandbox read-only. Reserved for future use.
  sandbox: "read-only"               # Sandbox mode (always read-only for review — do NOT change)
  context_budget: 20                 # Max files to review per session (default: 20)
  confidence_threshold: 80           # Min confidence % to report a finding (default: 80)
  # Which workflows use Codex Oracle. Remove a workflow name to skip Codex in that pipeline.
  # "mend" added in v1.39.0 for post-fix verification.
  # ── Timeout Configuration (v1.45.0+) ──
  # Outer GNU timeout for codex exec invocations (seconds).
  # Range: 300-3600. Default: 600. Minimum 5 min ensures xhigh reasoning has time.
  timeout: 600
  # Inner stream idle timeout — fires when model stops streaming (seconds).
  # Default: timeout - 60s. Must be < timeout.
  stream_idle_timeout: 540
  workflows: [review, audit, plan, forge, work, mend, goldmask, inspect]
  # Work advisory settings (Phase 4.5 of /rune:strive — non-blocking plan-vs-implementation check)
  work_advisory:
    enabled: true                    # Set false to skip advisory in work pipeline
    max_diff_size: 15000             # Truncate diff to this many chars (default: 15000)
  # Diff-focused review settings (for /rune:appraise — v1.31.0+)
  # When enabled, Codex Oracle reviews unified diffs instead of whole files.
  # This reduces irrelevant findings on unchanged code and improves token efficiency.
  # Only applies to /rune:appraise — /rune:audit always uses file-focused review.
  review_diff:
    enabled: true                      # Use diff instead of whole files (default: true)
    max_diff_size: 15000               # Max diff chars per codex exec batch (default: 15000)
    context_lines: 5                   # Lines of context around each change (default: 5)
    include_new_files_full: true       # Include full content for new/untracked files (default: true)
  # Cross-model verification settings (Phase 5.5 — hallucination guard)
  verification:
    enabled: true                    # Cross-model verification (recommended: true)
    fuzzy_match_threshold: 0.7       # Code snippet match threshold (0.0-1.0, default: 0.7)
    cross_model_bonus: 0.15          # Confidence boost when Claude + Codex agree on same finding (review/audit scope)
  # ── Deep Integration Keys (v1.39.0+) ──────────────────
  # Cross-model elicitation for adversarial reasoning methods
  elicitation:
    enabled: true                    # Cross-model structured reasoning (default: true)
    # QUAL-003: methods and timeout are consumed by the orchestrator's cross-model routing (elicitation/SKILL.md STEP 3-5).
    # Orchestrator codex invocation code ships with the routing protocol — these keys are active.
    methods: []                      # Auto-detect from codex_role column (empty OR omitted = all cross-model methods)
    timeout: 300                     # Codex timeout per elicitation invocation (default: 300s)
  # Post-fix Codex verification in /rune:mend
  mend_verification:
    enabled: true                    # Enable post-fix verification (default: true)
    max_diff_size: 15000             # Max diff chars for verification (default: 15000)
  # Codex Arena Judge in /rune:devise Phase 1.8
  arena:
    enabled: true                    # Enable Codex Arena Judge (default: true)
    role: "judge"                    # "judge" | "generator" | "both" (default: "judge")
    timeout: 300                     # Arena judge timeout (default: 300s)
    cross_model_bonus: 0.15          # Confidence bonus for cross-model agreement in arena (MC-3: separate from verification scope above)
  # Semantic contradiction detection in /rune:arc Phase 2.8
  # NOTE: Key is "semantic_verification" (not "verification_gate") to distinguish from Phase 2.7 (MC-2)
  semantic_verification:
    enabled: true                    # Enable semantic contradiction detection (default: true)
    timeout: 300                     # 5 min minimum for xhigh reasoning (default: 300s)
    reasoning: "xhigh"              # Overrides global codex.reasoning for this feature
  # Cross-model gap detection in /rune:arc Phase 5.6
  gap_analysis:
    enabled: true                    # Enable cross-model gap detection (default: true)
    timeout: 600                     # Gap analysis timeout (default: 600s)
  # Edge case suggestions for /rune:strive trial-forger
  trial_forger:
    enabled: true                    # Enable edge case suggestions before test writing (default: true)
    timeout: 300                     # 5 min minimum for xhigh reasoning (default: 300s)
    reasoning: "xhigh"              # Overrides global codex.reasoning for this feature
  # Rune Smith inline advisory during implementation
  rune_smith:
    enabled: false                   # DISABLED by default — opt-in only (cost-intensive per worker per task)
    timeout: 300                     # 5 min minimum for xhigh reasoning (default: 300s)
    reasoning: "xhigh"              # xhigh reasoning for maximum quality
    min_diff_size: 100               # Skip for trivial changes below this char count
    confidence_threshold: 90         # Only report CRITICAL findings (>= 90% confidence)
  # Cross-model complexity scoring in /rune:devise Phase 2.5 (Shatter)
  shatter:
    enabled: true                    # Enable cross-model complexity scoring (default: true)
    weight: 0.3                      # Codex weight in blended score (default: 0.3, range: 0.0-1.0)
  # Echo learning generalizability validation before persist
  echo_validation:
    enabled: true                    # Enable learning generalizability check (default: true)
    timeout: 300                     # 5 min minimum for xhigh reasoning (default: 300s)
    reasoning: "xhigh"              # xhigh reasoning for maximum quality
  # ── Codex Expansion Keys (v1.51.0+) ──────────────────
  # 10 additional inline cross-model verification points.
  # All follow the canonical 4-condition detection gate + SEC-003 temp file pattern.
  # 6 default-on (high ROI), 4 opt-in OFF (greenfield or niche).
  # Cross-model diff verification in /rune:appraise Phase 6.2
  # Verifies P1/P2 findings against actual diff hunks — 3-way verdict (CONFIRMED/WEAKENED/REFUTED)
  diff_verification:
    enabled: true                    # Default ON — high ROI, structured verdict (default: true)
    timeout: 300                     # Structured 3-way verdict, not deep analysis (default: 300s)
    reasoning: "high"               # high reasoning for structured verdict
  # Cross-model test coverage critique in /rune:arc Phase 7.8
  # Analyzes test report + diff for missing edge cases, brittle patterns, untested error paths
  test_coverage_critique:
    enabled: true                    # Default ON — catches coverage gaps cross-model (default: true)
    timeout: 600                     # Must trace coverage gaps across diff + test report (default: 600s)
    reasoning: "xhigh"              # xhigh — deep analysis of test coverage
  # Cross-model release quality check in /rune:arc Phase 8.55
  # Validates CHANGELOG completeness, breaking API changes, version bump conventions
  release_quality_check:
    enabled: true                    # Default ON — checklist-style validation (default: true)
    timeout: 300                     # Checklist-style, not deep analysis (default: 300s)
    reasoning: "high"               # high reasoning for structured validation
  # Cross-model section validation in /rune:forge Phase 1.7
  # Checks which plan sections reference high-risk files but have no Forge Gaze match
  section_validation:
    enabled: true                    # Default ON — binary coverage check (default: true)
    timeout: 300                     # Binary check — "does section reference files?" (default: 300s)
    reasoning: "medium"             # medium — simple binary check
  # Cross-model research tiebreaker in /rune:devise Phase 2.3.5
  # Conditional — only runs when research agents produce conflicting recommendations
  research_tiebreaker:
    enabled: true                    # Default ON — conditional, usually skips (default: true)
    timeout: 300                     # Compare 2-3 positions (default: 300s)
    reasoning: "high"               # high reasoning for conflict resolution
  # Cross-model task decomposition validation in /rune:arc Phase 4.5
  # Validates task granularity, dependencies, and file ownership conflicts before work begins
  task_decomposition:
    enabled: true                    # Default ON — structured granularity check (default: true)
    timeout: 300                     # Structured check (default: 300s)
    reasoning: "high"               # high reasoning for decomposition analysis
  # Cross-model risk amplification in Goldmask Phase 3.5
  # Traces 2nd/3rd-order risk chains that single-model analysis likely misses
  risk_amplification:
    enabled: false                   # OFF by default — greenfield, unproven value (opt-in)
    timeout: 600                     # Deep transitive dependency tracing (default: 600s)
    reasoning: "xhigh"              # xhigh — deep risk chain analysis
  # Cross-model drift detection in /rune:inspect Phase 1.5
  # Compares plan intent vs code semantics for pre-inspection drift signals
  drift_detection:
    enabled: false                   # OFF by default — greenfield, inspect already catches drift post-hoc (opt-in)
    timeout: 600                     # Plan-vs-code semantic comparison (default: 600s)
    reasoning: "xhigh"              # xhigh — semantic drift requires deep analysis
  # Cross-model architecture consistency review in /rune:audit Phase 6.3
  # Analyzes TOME findings for cross-cutting architectural patterns (audit mode only)
  architecture_review:
    enabled: false                   # OFF by default — audit-only niche use case (opt-in)
    timeout: 600                     # TOME aggregate analysis (default: 600s)
    reasoning: "xhigh"              # xhigh — cross-cutting pattern analysis
  # Cross-model post-monitor architectural critique in /rune:strive Phase 3.7
  # Analyzes all committed code vs plan for architectural drift after workers complete
  post_monitor_critique:
    enabled: false                   # OFF by default — post-execution signal has limited actionability (opt-in)
    timeout: 300                     # Committed code vs plan check (default: 300s)
    reasoning: "high"               # high reasoning for architectural comparison

# ──────────────────────────────────────────────
# Context Monitor — Runtime context rot prevention (v1.78.0+)
# ──────────────────────────────────────────────
context_monitor:
  enabled: true                    # Master toggle for context monitoring
  warning_threshold: 35            # Warn when remaining% <= this (default: 35)
  critical_threshold: 25           # Critical stop when remaining% <= this (default: 25)
  stale_seconds: 60                # Bridge file max age before ignoring (default: 60)
  debounce_calls: 5                # Tool uses between repeated warnings (default: 5)
  workflows: [review, audit, work, mend, arc, devise]  # Which workflows emit warnings

# ──────────────────────────────────────────────
# Arc — Cross-file consistency checks (v1.17.0+)
# ──────────────────────────────────────────────
# Declarative assertions that catch doc drift between files.
# Each check defines a single source of truth and one or more
# target files that must reflect the same value.
#
# Schema per check:
#   name:        Unique identifier (kebab-case)
#   description: Human-readable explanation of what stays in sync
#   source:
#     file:      File that holds the canonical value (glob OK for glob_count extractor)
#     extractor: How to pull the value — "json_field", "line_count", "glob_count", "regex_capture"
#     field:     Dot-path for json_field (e.g., "version", "name.first"), regex group for regex_capture, or omitted for line_count/glob_count
#   targets:     Array of files that must agree with the source value
#     - path:    Target file path (relative to repo root)
#       pattern: Regex or literal that must contain the source value.
#                Use {value} as placeholder for the extracted source value.
#   phase:       When to run — array of pipeline phases (default: ["plan"])
#                Valid phases: "plan", "post-work", "pre-review", "arc"
#
# arc:
#   consistency:
#     checks:
#       # Example 1: Version string must match across plugin.json, CLAUDE.md, and README.md
#       - name: version_sync
#         description: "Plugin version in plugin.json must match CLAUDE.md and README.md"
#         source:
#           file: ".claude-plugin/plugin.json"
#           extractor: json_field
#           field: "version"             # Plain dot-path (not JSONPath). Examples: "version", "name.first"
#         targets:
#           - path: "CLAUDE.md"
#             pattern: "version: {value}"
#           - path: "README.md"
#             pattern: "v{value}"
#         phase: ["plan", "post-work"]
#
#       # Example 2: Agent count in agents/review/ must match documented count
#       - name: agent_count
#         description: "Number of review agents must match CLAUDE.md and plugin.json"
#         source:
#           file: "agents/review/*.md"
#           extractor: glob_count        # glob_count: count files matching a glob pattern (e.g., *.md)
                                         # line_count: count lines in a single file
#         targets:
#           - path: "CLAUDE.md"
#             pattern: "{value} agents"
#           - path: ".claude-plugin/plugin.json"
#             pattern: "\"agentCount\": {value}"
#         phase: ["plan", "post-work", "pre-review"]
#
#       # Example 3: Elicitation method count must match across docs
#       - name: method_count
#         description: "Elicitation method count in methods.csv must match SKILL.md and phase-mapping.md"
#         source:
#           file: "skills/elicitation/references/methods.csv"
#           extractor: line_count
#         targets:
#           - path: "skills/elicitation/SKILL.md"
#             pattern: "{value} methods"
#           - path: "skills/elicitation/references/phase-mapping.md"
#             pattern: "{value} methods"
#         phase: ["plan", "arc"]

# ──────────────────────────────────────────────
# Goldmask — Cross-layer impact analysis (v1.37.0+)
# ──────────────────────────────────────────────
# Three-layer investigation: Impact (dependency tracing), Wisdom (git archaeology),
# Lore (quantitative risk scoring), plus Collateral Damage Detection.
# goldmask:
#   enabled: true                        # Master switch — disables ALL Goldmask across all workflows (default: true)
#   layers:
#     impact:
#       enabled: true                    # Enable Impact Layer (5 Haiku tracers)
#       tracer_model: haiku              # Model for impact tracers (haiku recommended for speed)
#       max_tracers: 5                   # Max concurrent tracers (default: 5, range: 1-8)
#       tracer_timeout: 120000           # Per-tracer timeout in ms (default: 120000 = 2 min)
#     wisdom:
#       enabled: true                    # Enable Wisdom Layer (git archaeology)
#       model: sonnet                    # Model for wisdom-sage (sonnet recommended for reasoning)
#       max_blame_files: 50             # Max files to git-blame (default: 50, range: 10-200)
#       max_findings_to_investigate: 20  # Max findings from Impact Layer to investigate (default: 20)
#       intent_classification: true      # Classify commit intent (bugfix, feature, refactor, etc.)
#       caution_threshold: 0.7          # Caution score threshold for flagging (0.0-1.0, default: 0.7)
#     lore:
#       enabled: true                    # Enable Lore Layer (quantitative git history)
#       model: haiku                     # Model for lore-analyst (haiku sufficient for metrics)
#       lookback_days: 180              # Git history lookback window in days (default: 180)
#       churn_threshold: 10             # File changes above this = high churn (default: 10)
#       co_change_min_support: 3        # Min co-change occurrences for clustering (default: 3)
#       ownership_concentration_warn: 0.8  # Warn when single author owns >N% of file (default: 0.8)
#     cdd:
#       enabled: true                    # Enable Collateral Damage Detection
#       noisy_or_threshold: 0.6         # Blast-radius score threshold (0.0-1.0, default: 0.6)
#       swarm_detection: true           # Detect bugs that travel in pairs (default: true)
#       swarm_lookback_commits: 50      # Commits to scan for swarm patterns (default: 50)
#   coordinator_model: sonnet            # Model for goldmask-coordinator (sonnet for synthesis)
#   double_check_top_n: 5               # Re-verify top N highest-risk findings (default: 5)
#   priority_weights:                    # Layer weights for final risk scoring (must sum to 1.0)
#     impact: 0.4                        # Weight for Impact Layer (default: 0.4)
#     wisdom: 0.35                       # Weight for Wisdom Layer (default: 0.35)
#     lore: 0.25                         # Weight for Lore Layer (default: 0.25)
#   modes:
#     quick: false                       # Skip Wisdom + Lore layers (Impact only)
#     deep: false                        # Extended lookback (360 days), lower thresholds
#   # ── Per-workflow Goldmask integration (v1.71.0+) ──
#   # Controls how each workflow uses Goldmask data.
#   # All defaults are true — Goldmask is always on unless explicitly disabled.
#   forge:
#     enabled: true                      # Enable Lore Layer in forge (default: true)
#                                        # Runs risk scoring on files referenced in plan before Forge Gaze selection.
#                                        # CRITICAL/HIGH files get score boost, forge agents receive risk context.
#                                        # Skip conditions: talisman → git guard → G5 guard → --no-lore flag
#   mend:
#     enabled: true                      # Master switch for mend Goldmask integration (default: true)
#     inject_context: true               # Inject risk/wisdom context into fixer prompts (default: true)
#                                        # Fixer agents receive file risk tiers, wisdom advisories, and
#                                        # blast-radius warnings from prior Goldmask outputs.
#     quick_check: true                  # Post-mend deterministic quick check (default: true)
#                                        # Compares MUST-CHANGE files from GOLDMASK.md against actual
#                                        # mend modifications. Reports untouched and unexpected changes.
#   devise:
#     enabled: true                      # Kill switch — disables Phase 2.3 Predictive Goldmask in /rune:devise (default: true)
#                                        # Set false to skip Phase 2.3 entirely even when goldmask.enabled is true.
#                                        # Checked at devise entry point; takes precedence over depth setting.
#     depth: basic                       # Predictive Goldmask depth (default: basic)
#                                        # basic    — 2 agents: lore-analyst + wisdom-sage (standard)
#                                        # enhanced — 6 agents: lore + 3 impact tracers + wisdom + coordinator (explicit opt-in)
#                                        # full     — 8 agents: all 5 impact tracers + lore + wisdom + coordinator (token-intensive — use for high-risk changes only)
#   inspect:
#     enabled: true                      # Enable Lore Layer in inspect (default: true)
#                                        # Runs risk scoring on scope files before inspector assignment.
#                                        # CRITICAL requirements get dual inspector coverage.
#     wisdom_passthrough: true           # Inject wisdom from prior Goldmask into inspector prompts (default: true)
#                                        # When available, wisdom advisories are passed through to inspectors
#                                        # with inspector-specific guidance notes.

# ── Stack-Aware Intelligence (v1.86.0+) ──
# Controls stack detection engine behavior and specialist reviewer selection.
# stack_awareness:
#   enabled: true                          # Master switch — disables all stack detection when false (default: true)
#   confidence_threshold: 0.6              # Minimum confidence for stack detection to activate (0.0-1.0, default: 0.6)
#                                          # Below this threshold, no specialist Ashes are summoned.
#   max_stack_ashes: 3                     # Maximum stack specialist Ashes per review session (default: 3)
#                                          # Controls how many language/framework/pattern specialists are added.
#                                          # Does not affect core Ashes (Ward Sentinel, Pattern Weaver, etc.).

# ── Figma Design Sync (v1.97.0+) ──
# Controls the /rune:design-sync pipeline and arc design phases.
# Requires Figma MCP server configured in .mcp.json for extraction.
# design_sync:
#   enabled: false                           # Master switch — must be true for design-sync to run (default: false)
#                                            # When false, arc design phases (3, 5.2, 7.6) are skipped entirely.
#   max_extraction_workers: 2                # Maximum design-sync-agent workers for extraction phase (default: 2)
#   max_implementation_workers: 3            # Maximum rune-smith workers for design implementation (default: 3)
#   max_iteration_workers: 2                 # Maximum design-iterator workers per iteration round (default: 2)
#   max_iterations: 5                        # Maximum fidelity iteration rounds before giving up (default: 5)
#                                            # Each round: review → identify worst dimension → fix → re-review.
#   iterate_enabled: false                   # Enable iterative refinement loop (default: false)
#                                            # When false, pipeline stops after first fidelity review (Phase 3).
#                                            # When true, triggers arc Phase 7.6 if score < fidelity_threshold.
#   fidelity_threshold: 80                   # Minimum fidelity score to pass (0-100, default: 80)
#                                            # Below this, iteration loop triggers (if iterate_enabled).
#                                            # Scoring: tokens 25%, layout 20%, responsive 15%, a11y 20%, variants 10%, states 10%.
#   token_snap_distance: 20                  # RGB distance threshold for color token snapping (default: 20)
#                                            # Colors within this distance of a design system token are snapped.
#                                            # Lower = stricter matching. Range: 0-50.
#   figma_cache_ttl: 1800                    # Figma API response cache TTL in seconds (default: 1800 = 30 min)
#                                            # Prevents redundant API calls during extraction.
#   design_tools:                            # Stack-awareness design tool integration
#     - figma                                # Figma MCP server (required for extraction)
#     - storybook                            # Storybook integration for component preview (optional)
