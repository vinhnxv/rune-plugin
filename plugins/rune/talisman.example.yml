# Rune Plugin Configuration
# Copy to .claude/talisman.yml (project-level) or ~/.claude/talisman.yml (global)
#
# Resolution order:
#   1. .claude/talisman.yml   (project, highest priority)
#   2. ~/.claude/talisman.yml (user global)
#   3. Plugin defaults           (6 built-in Ashes)

version: 1

# ──────────────────────────────────────────────
# Rune Gaze — File classification overrides
# ──────────────────────────────────────────────
rune-gaze:
  # Override which extensions map to backend Ash (Forge Warden)
  backend_extensions:
    - .py
    - .go
    - .rs
    - .rb

  # Override which extensions map to frontend Ash (Glyph Scribe)
  frontend_extensions:
    - .tsx
    - .ts
    - .jsx

  # Override which extensions map to infrastructure (Forge Warden)
  # Subset shown — see rune-gaze.md for all defaults (.sh, .bash, .zsh, .sql, .tf, .hcl, .tfvars, .dockerfile)
  # infra_extensions:
  #   - .tf
  #   - .sh
  #   - .sql

  # Override which extensions map to config (Forge Warden)
  # Subset shown — see rune-gaze.md for all defaults (.yml, .yaml, .json, .toml, .ini, .cfg, .conf, .env.example, .env.template)
  # config_extensions:
  #   - .yml
  #   - .yaml
  #   - .json
  #   - .toml

  # Min lines changed to summon Knowledge Keeper for doc files (default: 10)
  # doc_line_threshold: 10

  # Files/patterns to skip entirely (glob syntax)
  skip_patterns:
    - "**/migrations/**"
    - "**/*.generated.ts"
    - "**/vendor/**"

  # Files that should always be reviewed regardless of extension
  always_review:
    - "CLAUDE.md"
    - ".claude/**/*.md"

# ──────────────────────────────────────────────
# Custom Ashes — Extend the built-in 6
# ──────────────────────────────────────────────
# Each custom Ash joins the Roundtable Circle lifecycle:
#   - Gets a Truthbinding wrapper prompt (evidence, Seal, Glyph Budget)
#   - Participates in dedup via its unique finding_prefix
#   - Verified by Truthsight (if enabled)
#   - Findings aggregated into TOME.md
#
# Agent sources:
#   local  → .claude/agents/{name}.md (project-level)
#   global → ~/.claude/agents/{name}.md (user-level)
#   plugin → Full namespace like "my-plugin:review:agent-name"

ashes:
  custom:
    # Example 1: A local project-specific reviewer
    # Add 'forge' to workflows to enable Forge Gaze matching (see Example 3)
    - name: "domain-logic-reviewer"
      agent: "domain-logic-reviewer"       # Resolves to .claude/agents/domain-logic-reviewer.md
      source: local
      workflows: [review, audit]
      trigger:
        extensions: [".py", ".rb", ".go"]
        paths: ["src/domain/", "src/services/", "app/models/"]
      context_budget: 20
      finding_prefix: "DOM"
      required_sections:
        - "P1 (Critical)"
        - "P2 (High)"
        - "P3 (Medium)"
        - "Summary"
        - "Self-Review Log"

    # Example 2: A global user-level performance agent
    - name: "perf-deep-scan"
      agent: "perf-deep-scan"              # Resolves to ~/.claude/agents/perf-deep-scan.md
      source: global
      workflows: [audit]                   # Audit only (too heavy for PR reviews)
      trigger:
        extensions: [".py", ".ts", ".tsx", ".rb"]
        min_files: 10                      # Only summon if 10+ matching files
      context_budget: 20
      finding_prefix: "PERF"

    # Example 3: A review + forge agent (participates in all workflows)
    # Forge is default in /rune:plan and /rune:forge — custom agents participate
    # via topic matching when "forge" is in their workflows list.
    - name: "api-contract-reviewer"
      agent: "api-contract-reviewer"       # Resolves to .claude/agents/api-contract-reviewer.md
      source: local
      workflows: [review, audit, forge]    # "forge" enables Forge Gaze topic matching
      trigger:
        extensions: [".py", ".ts"]         # For review/audit (file-based matching)
        paths: ["src/api/", "api/"]
        topics: [api, contract, endpoints, rest, graphql]  # For forge (topic-based matching)
      forge:                               # Required when "forge" is in workflows
        subsection: "API Contract Analysis"
        perspective: "API design, contract compatibility, and endpoint patterns"
        budget: enrichment                 # "enrichment" (lightweight) or "research" (web search)
      context_budget: 15
      finding_prefix: "API"

    # Example 4: An agent from another installed plugin
    # SECURITY: Cross-plugin agents are resolved by namespace prefix.
    # The agent name must match `{plugin}:{category}:{agent}` exactly.
    # Path traversal (../) in agent names is rejected at load time.
    # - name: "compliance-checker"
    #   agent: "my-plugin:review:compliance-checker"
    #   source: plugin
    #   workflows: [review, audit]
    #   trigger:
    #     extensions: ["*"]                # All file types
    #     paths: ["src/api/", "src/auth/"]
    #   context_budget: 15
    #   finding_prefix: "COMP"

# ──────────────────────────────────────────────
# Settings — Global behavior adjustments
# ──────────────────────────────────────────────
settings:
  # Hard cap on total Ash (built-in + custom)
  # Max recommended: 8 (verifier context budget constraint)
  max_ashes: 8

  # Extended dedup hierarchy — higher = wins on conflict
  # Must include ALL active prefixes (built-in + custom)
  # Built-in prefixes: SEC, BACK, DOC, QUAL, FRONT, CDX
  dedup_hierarchy:
    - SEC          # Ward Sentinel (always highest)
    - BACK         # Forge Warden
    - API          # Custom: api-contract-reviewer
    - DOM          # Custom: domain-logic-reviewer
    - PERF         # Custom: perf-deep-scan
    - DOC          # Knowledge Keeper
    - QUAL         # Pattern Weaver
    - FRONT        # Glyph Scribe
    - CDX          # Codex Oracle (lowest — cross-model findings defer to all built-in Ashes)

  # Whether Truthsight Layer 2 verifier checks custom Ash outputs
  verification:
    layer_2_custom_agents: true

# ──────────────────────────────────────────────
# Defaults — Disable built-in Ash
# ──────────────────────────────────────────────
# Use this to turn off a built-in Ash you've replaced with a custom one
defaults:
  disable_ashes: []
  # Example: disable_ashes: ["knowledge-keeper"]

# ──────────────────────────────────────────────
# Forge — Forge Gaze selection overrides (forge runs by default)
# ──────────────────────────────────────────────
# Forge enrichment is enabled by default in /rune:plan and /rune:forge.
# Use --quick with /rune:plan to skip forge, or --exhaustive for deeper research.
# forge:
#   threshold: 0.30          # Score threshold for agent selection (0.0-1.0)
#   max_per_section: 3       # Max agents per plan section (upper bound: 5)
#   max_total_agents: 8      # Max total agents across all sections (upper bound: 15)

# ──────────────────────────────────────────────
# Plan — Verification gate patterns
# ──────────────────────────────────────────────
# Custom patterns for the plan verification gate (Phase 4B.5).
# Each pattern runs with zero LLM hallucination risk (deterministic grep).
# plan:
#   verification_patterns:
#     # Each pattern may include a `phase` field — an array of pipeline phases
#     # when this check should run. Valid values: "plan", "post-work", "pre-review", "arc"
#     # If `phase` is omitted, defaults to ["plan"] (backward-compatible).
#     - regex: '"11 commands"'
#       paths: "plugins/rune/ .claude-plugin/"
#       exclusions: "--glob '!commands/plan.md'"
#       expect_zero: true
#       description: "Command count updated to 12"
#       phase: ["plan"]                    # Only during planning (default behavior)
#     - regex: '"--skip-forge"'
#       paths: "plugins/rune/"
#       exclusions: "--glob '!commands/plan.md' --glob '!CHANGELOG.md'"
#       expect_zero: true
#       description: "Flag renamed to --no-forge"
#       phase: ["plan", "post-work"]       # Check during plan AND after work completes
#     # Example: a check that only runs post-work (not during planning)
#     # - regex: 'TODO\(v1\.16\)'
#     #   paths: "plugins/rune/"
#     #   expect_zero: true
#     #   description: "All v1.16 TODOs resolved"
#     #   phase: ["post-work", "pre-review"]  # Only after implementation

# ──────────────────────────────────────────────
# Plan — Freshness gate (v1.26.0+)
# ──────────────────────────────────────────────
# Pre-flight check in /rune:arc that detects when a plan's
# source codebase has drifted significantly since plan creation.
# Requires git_sha in plan frontmatter (added by /rune:plan v1.26.0+).
# Plans without git_sha gracefully skip the check.
#
# NOTE: These settings go under the same `plan:` key as verification_patterns above.
# In your talisman.yml, merge both blocks under a single `plan:` key:
#   plan:
#     verification_patterns: [...]
#     freshness:
#       enabled: true
#       ...
#
# QUAL-016 FIX: freshness block belongs under plan: key, not at top level.
# Merge these settings under the `plan:` key above, like:
#   plan:
#     verification_patterns: [...]
#     freshness:
#       enabled: true
#       ...
#
#   plan.freshness:
#     enabled: true              # Set false to disable freshness check globally
#     warn_threshold: 0.7        # Score below this → WARN (float, 0.01-1.0)
#     block_threshold: 0.4       # Score below this → STALE (float, 0.0-0.99, must be < warn)
#                                # Note: block_threshold can be 0.0 (disables blocking).
#                                # warn_threshold minimum is 0.01 — to disable warnings entirely,
#                                # set enabled: false instead.
#     max_commit_distance: 100   # Commits beyond this → max drift signal (clamped 1-10000)

# ──────────────────────────────────────────────
# Arc — Pipeline timeout overrides (v1.12.0+)
# ──────────────────────────────────────────────
# Per-phase timeout overrides for /rune:arc. Values in milliseconds.
# Hardcoded defaults — talisman-configurable timeouts are planned for a
# future release.
# arc:
#   timeouts:
#     forge: 900000           # 15 minutes (default: inner 10m + 5m setup)
#     plan_review: 900000     # 15 minutes (default: inner 10m + 5m setup)
#     plan_refine: 180000     # 3 minutes (default, orchestrator-only)
#     verification: 30000     # 30 seconds (default, orchestrator-only, deterministic)
#     work: 2100000           # 35 minutes (default: inner 30m + 5m setup)
#     gap_analysis: 60000     # 1 minute (default, orchestrator-only, deterministic)
#     code_review: 900000     # 15 minutes (default: inner 10m + 5m setup)
#     mend: 1380000           # 23 minutes (default: inner 15m + 5m setup + 3m ward)
#     verify_mend: 240000     # 4 minutes (default, orchestrator-only)
#     audit: 1200000          # 20 minutes (default: inner 15m + 5m setup)
#     total: 7200000          # 120 minutes total pipeline (default)

# ──────────────────────────────────────────────
# Solution Arena — Competitive solution evaluation (v1.24.0+)
# ──────────────────────────────────────────────
# Phase 1.8 in /rune:plan — generates 2-5 alternative solutions and
# evaluates them via Devil's Advocate + Innovation Scout challengers.
# Weighted decision matrix selects the champion approach.
# Arena runs by default. Use --no-arena to skip, or disable globally below.
solution_arena:
  enabled: true                      # Set false to disable Arena globally
  skip_for_types: ["fix"]           # Feature types that skip Arena (fix = simple bug fixes)
  # Additional config (weights, thresholds) available in future versions

# ──────────────────────────────────────────────
# Elicitation — Structured reasoning agent (v1.31.0+)
# ──────────────────────────────────────────────
# The elicitation-sage is summoned in plan, forge, review, and mend phases
# to apply BMAD-derived structured reasoning methods (Tree of Thoughts,
# Pre-mortem, Red Team, 5 Whys, etc.).
# Set enabled: false to disable all sage invocations without reverting code.
elicitation:
  enabled: true                    # Set false to disable all sage invocations globally

# ──────────────────────────────────────────────
# Echoes — Memory persistence
# ──────────────────────────────────────────────
echoes:
  version_controlled: false    # Set true to track .claude/echoes/ in git

# ──────────────────────────────────────────────
# Review — Chunked review and convergence settings (v1.35.0+)
# ──────────────────────────────────────────────
# review:
  # Chunked review settings (triggered when changed files exceed chunk_threshold)
  # SEC-005 FIX: Document valid ranges for numeric config values
  # chunk_threshold: 20        # Files above this trigger chunking (default: 20, range: 5-200)
  # chunk_target_size: 15      # Target files per chunk (default: 15, range: 3-50)
  # max_chunks: 5              # Circuit breaker — max chunks before redistribution (default: 5, range: 1-20)
  # cross_cutting_pass: true   # Enable cross-cutting inter-module review pass (default: true)
  # chunk_strategy: "directory" # "directory" (group by dir) | "flat" (simple split) (default: directory) [RESERVED — not yet consumed]
  #
  # Convergence loop settings (adaptive 3-tier system)
  # convergence_enabled: true              # Enable review convergence loop (default: true)
  # convergence_tier_override: null        # Force tier: "minimal" | "standard" | "thorough" | null (auto-detect)
  # convergence_density_threshold: 0.3     # Min findings/file for code chunks (default: 0.3)
  # convergence_evidence_threshold: 0.7    # Min findings-with-evidence ratio (default: 0.7)
  # convergence_confidence_threshold: 0.6  # Min avg confidence score (default: 0.6)
  # convergence_coverage_threshold: 0.4    # Min files-with-findings ratio for code chunks (default: 0.4)

# ──────────────────────────────────────────────
# Work — Swarm execution settings
# ──────────────────────────────────────────────
work:
  ward_commands:               # Quality gate commands for /rune:work
    - "make check"
    - "npm test"
  max_workers: 3               # Max parallel swarm workers
  approve_timeout: 180         # Seconds to wait for task proposal approval (default: 180)
  commit_format: "rune: {subject} [ward-checked]"  # Commit message template
  skip_branch_check: false     # Skip Phase 0.5 branch/environment check (default: false)
  branch_prefix: "rune/work"   # Branch name prefix (must match /^[a-zA-Z0-9][a-zA-Z0-9._\-\/]*$/ AND must not contain '..', default: "rune/work")
  pr_monitoring: false          # Include post-deploy monitoring section in PR body (default: false)
  # pr_template: default        # Reserved for a future release — only "default" currently implemented
  # auto_push: false            # Reserved for a future release — auto-push without confirmation
  co_authors: []                # Additional Co-Authored-By lines in "Name <email>" format (default: [])
  # Example: ["Claude <noreply@anthropic.com>", "Alice <alice@example.com>"]
  # consistency:                   # Doc-consistency checks for Phase 4.3 (v1.19.0+)
  #   checks: []                   # Same schema as arc.consistency.checks. If empty, falls back to arc checks, then defaults.

# ──────────────────────────────────────────────
# Codex Oracle — Cross-model verification (v1.18.0+)
# ──────────────────────────────────────────────
# Codex Oracle is auto-detected when the `codex` CLI is installed
# (npm install -g @openai/codex). It provides a second AI perspective
# (GPT-5.3-codex) alongside Claude's built-in Ashes, catching issues
# that single-model blind spots miss.
#
# When enabled, Codex Oracle:
#   - Joins the Roundtable Circle as a built-in Ash (CDX prefix)
#   - Runs codex exec in read-only sandbox mode
#   - Findings are verified against actual source code (Phase 5.5)
#   - Cross-validated findings (Claude + Codex agree) get a confidence boost
#   - Hallucinated findings (fabricated file/code references) are removed
#
# Prerequisites:
#   - codex CLI installed: npm install -g @openai/codex
#   - OpenAI account authenticated via codex CLI (Rune does NOT manage API keys)
#   - jq recommended for structured JSONL parsing (raw text fallback if unavailable)
#
# Disable Codex Oracle entirely by setting disabled: true.
# This is the runtime kill switch — no code changes needed.
codex:
  disabled: false                    # Set true to disable Codex Oracle entirely
  model: "gpt-5.3-codex"            # Codex model — only gpt-5.x-codex supported (e.g., gpt-5-codex, gpt-5.2-codex, gpt-5.3-codex)
  reasoning: "high"                  # Reasoning effort (high, medium, low)
  # NOTE: sandbox is currently ignored — codex always uses --sandbox read-only. Reserved for future use.
  sandbox: "read-only"               # Sandbox mode (always read-only for review — do NOT change)
  context_budget: 20                 # Max files to review per session (default: 20)
  confidence_threshold: 80           # Min confidence % to report a finding (default: 80)
  # Which workflows use Codex Oracle. Remove a workflow name to skip Codex in that pipeline.
  workflows: [review, audit, plan, forge, work]
  # Work advisory settings (Phase 4.5 of /rune:work — non-blocking plan-vs-implementation check)
  work_advisory:
    enabled: true                    # Set false to skip advisory in work pipeline
    max_diff_size: 15000             # Truncate diff to this many chars (default: 15000)
  # Diff-focused review settings (for /rune:review — v1.31.0+)
  # When enabled, Codex Oracle reviews unified diffs instead of whole files.
  # This reduces irrelevant findings on unchanged code and improves token efficiency.
  # Only applies to /rune:review — /rune:audit always uses file-focused review.
  review_diff:
    enabled: true                      # Use diff instead of whole files (default: true)
    max_diff_size: 15000               # Max diff chars per codex exec batch (default: 15000)
    context_lines: 5                   # Lines of context around each change (default: 5)
    include_new_files_full: true       # Include full content for new/untracked files (default: true)
  # Cross-model verification settings (Phase 5.5 — hallucination guard)
  verification:
    enabled: true                    # Cross-model verification (recommended: true)
    fuzzy_match_threshold: 0.7       # Code snippet match threshold (0.0-1.0, default: 0.7)
    cross_model_bonus: 0.15          # Confidence boost when Claude + Codex agree on same finding

# ──────────────────────────────────────────────
# Arc — Cross-file consistency checks (v1.17.0+)
# ──────────────────────────────────────────────
# Declarative assertions that catch doc drift between files.
# Each check defines a single source of truth and one or more
# target files that must reflect the same value.
#
# Schema per check:
#   name:        Unique identifier (kebab-case)
#   description: Human-readable explanation of what stays in sync
#   source:
#     file:      File that holds the canonical value (glob OK for glob_count extractor)
#     extractor: How to pull the value — "json_field", "line_count", "glob_count", "regex_capture"
#     field:     Dot-path for json_field (e.g., "version", "name.first"), regex group for regex_capture, or omitted for line_count/glob_count
#   targets:     Array of files that must agree with the source value
#     - path:    Target file path (relative to repo root)
#       pattern: Regex or literal that must contain the source value.
#                Use {value} as placeholder for the extracted source value.
#   phase:       When to run — array of pipeline phases (default: ["plan"])
#                Valid phases: "plan", "post-work", "pre-review", "arc"
#
# arc:
#   consistency:
#     checks:
#       # Example 1: Version string must match across plugin.json, CLAUDE.md, and README.md
#       - name: version_sync
#         description: "Plugin version in plugin.json must match CLAUDE.md and README.md"
#         source:
#           file: ".claude-plugin/plugin.json"
#           extractor: json_field
#           field: "version"             # Plain dot-path (not JSONPath). Examples: "version", "name.first"
#         targets:
#           - path: "CLAUDE.md"
#             pattern: "version: {value}"
#           - path: "README.md"
#             pattern: "v{value}"
#         phase: ["plan", "post-work"]
#
#       # Example 2: Agent count in agents/review/ must match documented count
#       - name: agent_count
#         description: "Number of review agents must match CLAUDE.md and plugin.json"
#         source:
#           file: "agents/review/*.md"
#           extractor: glob_count        # glob_count: count files matching a glob pattern (e.g., *.md)
                                         # line_count: count lines in a single file
#         targets:
#           - path: "CLAUDE.md"
#             pattern: "{value} agents"
#           - path: ".claude-plugin/plugin.json"
#             pattern: "\"agentCount\": {value}"
#         phase: ["plan", "post-work", "pre-review"]
#
#       # Example 3: Elicitation method count must match across docs
#       - name: method_count
#         description: "Elicitation method count in methods.csv must match SKILL.md and phase-mapping.md"
#         source:
#           file: "skills/elicitation/references/methods.csv"
#           extractor: line_count
#         targets:
#           - path: "skills/elicitation/SKILL.md"
#             pattern: "{value} methods"
#           - path: "skills/elicitation/references/phase-mapping.md"
#             pattern: "{value} methods"
#         phase: ["plan", "arc"]
