# Rune Plugin Configuration
# Copy to .claude/talisman.yml (project-level) or ~/.claude/talisman.yml (global)
#
# Resolution order:
#   1. .claude/talisman.yml   (project, highest priority)
#   2. ~/.claude/talisman.yml (user global)
#   3. Plugin defaults           (5 built-in Ashes)

version: 1

# ──────────────────────────────────────────────
# Rune Gaze — File classification overrides
# ──────────────────────────────────────────────
rune-gaze:
  # Override which extensions map to backend Ash (Forge Warden)
  backend_extensions:
    - .py
    - .go
    - .rs
    - .rb

  # Override which extensions map to frontend Ash (Glyph Scribe)
  frontend_extensions:
    - .tsx
    - .ts
    - .jsx

  # Override which extensions map to infrastructure (Forge Warden)
  # Subset shown — see rune-gaze.md for all defaults (.sh, .bash, .zsh, .sql, .tf, .hcl, .tfvars, .dockerfile)
  # infra_extensions:
  #   - .tf
  #   - .sh
  #   - .sql

  # Override which extensions map to config (Forge Warden)
  # Subset shown — see rune-gaze.md for all defaults (.yml, .yaml, .json, .toml, .ini, .cfg, .conf, .env.example, .env.template)
  # config_extensions:
  #   - .yml
  #   - .yaml
  #   - .json
  #   - .toml

  # Min lines changed to summon Knowledge Keeper for doc files (default: 10)
  # doc_line_threshold: 10

  # Files/patterns to skip entirely (glob syntax)
  skip_patterns:
    - "**/migrations/**"
    - "**/*.generated.ts"
    - "**/vendor/**"

  # Files that should always be reviewed regardless of extension
  always_review:
    - "CLAUDE.md"
    - ".claude/**/*.md"

# ──────────────────────────────────────────────
# Custom Ashes — Extend the built-in 5
# ──────────────────────────────────────────────
# Each custom Ash joins the Roundtable Circle lifecycle:
#   - Gets a Truthbinding wrapper prompt (evidence, Seal, Glyph Budget)
#   - Participates in dedup via its unique finding_prefix
#   - Verified by Truthsight (if enabled)
#   - Findings aggregated into TOME.md
#
# Agent sources:
#   local  → .claude/agents/{name}.md (project-level)
#   global → ~/.claude/agents/{name}.md (user-level)
#   plugin → Full namespace like "my-plugin:review:agent-name"

ashes:
  custom:
    # Example 1: A local project-specific reviewer
    # Add 'forge' to workflows to enable Forge Gaze matching (see Example 3)
    - name: "domain-logic-reviewer"
      agent: "domain-logic-reviewer"       # Resolves to .claude/agents/domain-logic-reviewer.md
      source: local
      workflows: [review, audit]
      trigger:
        extensions: [".py", ".rb", ".go"]
        paths: ["src/domain/", "src/services/", "app/models/"]
      context_budget: 20
      finding_prefix: "DOM"
      required_sections:
        - "P1 (Critical)"
        - "P2 (High)"
        - "P3 (Medium)"
        - "Summary"
        - "Self-Review Log"

    # Example 2: A global user-level performance agent
    - name: "perf-deep-scan"
      agent: "perf-deep-scan"              # Resolves to ~/.claude/agents/perf-deep-scan.md
      source: global
      workflows: [audit]                   # Audit only (too heavy for PR reviews)
      trigger:
        extensions: [".py", ".ts", ".tsx", ".rb"]
        min_files: 10                      # Only summon if 10+ matching files
      context_budget: 20
      finding_prefix: "PERF"

    # Example 3: A review + forge agent (participates in all workflows)
    # Forge is default in /rune:plan and /rune:forge — custom agents participate
    # via topic matching when "forge" is in their workflows list.
    - name: "api-contract-reviewer"
      agent: "api-contract-reviewer"       # Resolves to .claude/agents/api-contract-reviewer.md
      source: local
      workflows: [review, audit, forge]    # "forge" enables Forge Gaze topic matching
      trigger:
        extensions: [".py", ".ts"]         # For review/audit (file-based matching)
        paths: ["src/api/", "api/"]
        topics: [api, contract, endpoints, rest, graphql]  # For forge (topic-based matching)
      forge:                               # Required when "forge" is in workflows
        subsection: "API Contract Analysis"
        perspective: "API design, contract compatibility, and endpoint patterns"
        budget: enrichment                 # "enrichment" (lightweight) or "research" (web search)
      context_budget: 15
      finding_prefix: "API"

    # Example 4: An agent from another installed plugin
    # SECURITY: Cross-plugin agents are resolved by namespace prefix.
    # The agent name must match `{plugin}:{category}:{agent}` exactly.
    # Path traversal (../) in agent names is rejected at load time.
    # - name: "compliance-checker"
    #   agent: "my-plugin:review:compliance-checker"
    #   source: plugin
    #   workflows: [review, audit]
    #   trigger:
    #     extensions: ["*"]                # All file types
    #     paths: ["src/api/", "src/auth/"]
    #   context_budget: 15
    #   finding_prefix: "COMP"

# ──────────────────────────────────────────────
# Settings — Global behavior adjustments
# ──────────────────────────────────────────────
settings:
  # Hard cap on total Ash (built-in + custom)
  # Max recommended: 8 (verifier context budget constraint)
  max_ashes: 8

  # Extended dedup hierarchy — higher = wins on conflict
  # Must include ALL active prefixes (built-in + custom)
  # Built-in prefixes: SEC, BACK, DOC, QUAL, FRONT
  dedup_hierarchy:
    - SEC          # Ward Sentinel (always highest)
    - BACK         # Forge Warden
    - API          # Custom: api-contract-reviewer
    - DOM          # Custom: domain-logic-reviewer
    - PERF         # Custom: perf-deep-scan
    - DOC          # Knowledge Keeper
    - QUAL         # Pattern Weaver
    - FRONT        # Glyph Scribe (lowest)

  # Whether Truthsight Layer 2 verifier checks custom Ash outputs
  verification:
    layer_2_custom_agents: true

# ──────────────────────────────────────────────
# Defaults — Disable built-in Ash
# ──────────────────────────────────────────────
# Use this to turn off a built-in Ash you've replaced with a custom one
defaults:
  disable_ashes: []
  # Example: disable_ashes: ["knowledge-keeper"]

# ──────────────────────────────────────────────
# Forge — Forge Gaze selection overrides (forge runs by default)
# ──────────────────────────────────────────────
# Forge enrichment is enabled by default in /rune:plan and /rune:forge.
# Use --quick with /rune:plan to skip forge, or --exhaustive for deeper research.
# forge:
#   threshold: 0.30          # Score threshold for agent selection (0.0-1.0)
#   max_per_section: 3       # Max agents per plan section (upper bound: 5)
#   max_total_agents: 8      # Max total agents across all sections (upper bound: 15)

# ──────────────────────────────────────────────
# Plan — Verification gate patterns
# ──────────────────────────────────────────────
# Custom patterns for the plan verification gate (Phase 4B.5).
# Each pattern runs with zero LLM hallucination risk (deterministic grep).
# plan:
#   verification_patterns:
#     - regex: '"11 commands"'
#       paths: "plugins/rune/ .claude-plugin/"
#       exclusions: "--glob '!commands/plan.md'"
#       expect_zero: true
#       description: "Command count updated to 12"
#     - regex: '"--skip-forge"'
#       paths: "plugins/rune/"
#       exclusions: "--glob '!commands/plan.md' --glob '!CHANGELOG.md'"
#       expect_zero: true
#       description: "Flag renamed to --no-forge"

# ──────────────────────────────────────────────
# Arc — Pipeline timeout overrides (v1.12.0+)
# ──────────────────────────────────────────────
# Per-phase timeout overrides for /rune:arc. Values in milliseconds.
# Hardcoded defaults are used in v1.11.0 — talisman-configurable timeouts
# are planned for v1.12.0+.
# arc:
#   timeouts:
#     forge: 600000           # 10 minutes (default)
#     plan_review: 600000     # 10 minutes (default)
#     plan_refine: 180000     # 3 minutes (default, orchestrator-only)
#     verification: 30000     # 30 seconds (default, orchestrator-only, deterministic)
#     work: 1860000           # 31 minutes (default)
#     code_review: 660000     # 11 minutes (default)
#     mend: 960000            # 16 minutes (default)
#     audit: 960000           # 16 minutes (default)
#     total: 5400000          # 90 minutes total pipeline (default)

# ──────────────────────────────────────────────
# Echoes — Memory persistence
# ──────────────────────────────────────────────
echoes:
  version_controlled: false    # Set true to track .claude/echoes/ in git

# ──────────────────────────────────────────────
# Work — Swarm execution settings
# ──────────────────────────────────────────────
work:
  ward_commands:               # Quality gate commands for /rune:work
    - "make check"
    - "npm test"
  max_workers: 3               # Max parallel swarm workers
  approve_timeout: 180         # Seconds to wait for task proposal approval (default: 180)
  commit_format: "rune: {subject} [ward-checked]"  # Commit message template
  skip_branch_check: false     # Skip Phase 0.5 branch/environment check (default: false)
  branch_prefix: "rune/work"   # Branch name prefix (must match /^[a-zA-Z0-9][a-zA-Z0-9_\-\/]*$/, default: "rune/work")
  pr_monitoring: false          # Include post-deploy monitoring section in PR body (default: false)
  # pr_template: default        # Reserved for v1.13.0 — only "default" currently implemented
  # auto_push: false            # Reserved for v1.13.0 — auto-push without confirmation
  co_authors: []                # Additional Co-Authored-By lines in "Name <email>" format (default: [])
  # Example: ["Claude <noreply@anthropic.com>", "Alice <alice@example.com>"]
