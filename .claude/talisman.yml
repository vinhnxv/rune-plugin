version: 1

# ──────────────────────────────────────────────
# Rune Gaze — File classification overrides
# ──────────────────────────────────────────────
rune-gaze:
  backend_extensions:
    - .py
    - .go
    - .rs
    - .rb

  frontend_extensions:
    - .tsx
    - .ts
    - .jsx

  skip_patterns:
    - "**/migrations/**"
    - "**/*.generated.ts"
    - "**/vendor/**"

  always_review:
    - "CLAUDE.md"
    - ".claude/**/*.md"

# ──────────────────────────────────────────────
# Settings — Global behavior adjustments
# ──────────────────────────────────────────────
settings:
  max_ashes: 9
  max_cli_ashes: 2 # Sub-cap on CLI-backed Ashes (v1.57.0+)
  dedup_hierarchy:
    - SEC # Ward Sentinel (always highest)
    - BACK # Forge Warden
    - VEIL # Veil Piercer (truth-telling)
    - DOUBT # Doubt Seer (meta-findings, non-deduplicable)
    - PY # Python Reviewer (stack specialist, v1.86.0+)
    - TSR # TypeScript Reviewer (stack specialist, v1.86.0+)
    - RST # Rust Reviewer (stack specialist, v1.86.0+)
    - PHP # PHP Reviewer (stack specialist, v1.86.0+)
    - FAPI # FastAPI Reviewer (stack specialist, v1.86.0+)
    - DJG # Django Reviewer (stack specialist, v1.86.0+)
    - LARV # Laravel Reviewer (stack specialist, v1.86.0+)
    - SQLA # SQLAlchemy Reviewer (stack specialist, v1.86.0+)
    - TDD # TDD Compliance Reviewer (stack specialist, v1.86.0+)
    - DDD # DDD Reviewer (stack specialist, v1.86.0+)
    - DI # DI Reviewer (stack specialist, v1.86.0+)
    - DOC # Knowledge Keeper
    - QUAL # Pattern Weaver
    - FRONT # Glyph Scribe
    - CDX # Codex Oracle (lowest — cross-model findings defer to all built-in Ashes)
  verification:
    layer_2_custom_agents: true

# ──────────────────────────────────────────────
# Audit — Deep audit + incremental settings (v1.56.0+)
# ──────────────────────────────────────────────
audit:
  deep:
    enabled: true
    ashes:
      - rot-seeker
      - strand-tracer
      - decree-auditor
      - fringe-watcher
    max_deep_ashes: 4
    timeout_multiplier: 1.5
    dimensions:
      - truth-seeker
      - ruin-watcher
      - breach-hunter
      - order-auditor
      - ember-seer
      - signal-watcher
      - decay-tracer
    max_dimension_agents: 7
  always_deep: false

# ──────────────────────────────────────────────
# Defaults — Disable built-in Ash
# ──────────────────────────────────────────────
defaults:
  disable_ashes: []

# ──────────────────────────────────────────────
# Inspect — Plan-vs-implementation audit (v1.50.0+)
# ──────────────────────────────────────────────
inspect:
  max_inspectors: 4
  completion_threshold: 80
  gap_threshold: 20
  max_fixes: 20
  fix_timeout: 600000

# ──────────────────────────────────────────────
# Solution Arena — Competitive solution evaluation (v1.24.0+)
# ──────────────────────────────────────────────
solution_arena:
  enabled: true
  skip_for_types: ["fix"]

# ──────────────────────────────────────────────
# Elicitation — Structured reasoning agent (v1.31.0+)
# ──────────────────────────────────────────────
elicitation:
  enabled: true

# ──────────────────────────────────────────────
# Echoes — Memory persistence
# ──────────────────────────────────────────────
echoes:
  version_controlled: false

# ──────────────────────────────────────────────
# Horizon — Strategic depth assessment (v1.47.0+)
# ──────────────────────────────────────────────
horizon:
  enabled: true
  intent_default: "long-term"

# ──────────────────────────────────────────────
# Doubt Seer — Cross-agent false-positive verification
# ──────────────────────────────────────────────
doubt_seer:
  enabled: true
  workflows: [review, audit]
  challenge_threshold: "P2"
  max_challenges: 30
  block_on_unproven: false
  unproven_threshold: 0.8

# ──────────────────────────────────────────────
# Review — Chunked review, convergence, and sharding (v1.35.0+)
# ──────────────────────────────────────────────
review:
  chunk_threshold: 20
  chunk_target_size: 15
  max_chunks: 5
  cross_cutting_pass: true
  chunk_strategy: "directory"
  convergence_enabled: true
  convergence_tier_override: null
  convergence_density_threshold: 0.3
  convergence_evidence_threshold: 0.7
  convergence_confidence_threshold: 0.6
  convergence_coverage_threshold: 0.4

  # ── Inscription Sharding (v1.98.0+) ──
  large_diff_threshold: 25
  chunk_size: 15
  shard_threshold: 15
  shard_size: 12
  max_shards: 5
  cross_shard_sentinel: true
  shard_model_policy: auto
  reshard_threshold: 30

# ──────────────────────────────────────────────
# Work — Swarm execution settings
# ──────────────────────────────────────────────
# This is a documentation-only plugin (no compiled code / test suite).
# Ward commands validate markdown structure and cross-file consistency.
work:
  # SEC: ward_commands are executed as raw shell. Changes to this file should be reviewed for command injection.
  # SEC: ward_commands are validated at runtime by SAFE_WARD regex and SAFE_EXECUTABLES allowlist
  # (see roundtable-circle/references/ward-check.md). sh/bash are intentionally excluded.
  # Only allowlisted executables (jq, python, npm, etc.) may appear as the first token.
  ward_commands:
    # NOTE: This command uses Bash command substitution ($(...)). Ensure jq is available.
    - 'echo ''ward: checking plugin.json sync'' && [ "$(jq -r .version plugins/rune/.claude-plugin/plugin.json)" = "$(jq -r ''.plugins[0].version'' .claude-plugin/marketplace.json)" ]'
  max_workers: 3
  approve_timeout: 180
  commit_format: "rune: {subject} [ward-checked]"
  skip_branch_check: false
  branch_prefix: "rune/work"
  pr_monitoring: false
  co_authors: []
  todos_per_worker: 3

# ──────────────────────────────────────────────
# Mend — Parallel finding resolution (v1.51.0+)
# ──────────────────────────────────────────────
mend:
  cross_file_batch_size: 4
  todos_per_fixer: 5

# ──────────────────────────────────────────────
# Inner Flame — Self-review protocol (v1.46.0+)
# ──────────────────────────────────────────────
inner_flame:
  enabled: true
  block_on_fail: true
  confidence_floor: 60

# ──────────────────────────────────────────────
# File Todos — Structured todo tracking (v1.101.0+)
# ──────────────────────────────────────────────
# Session-scoped: todos live in tmp/{workflow}/{id}/todos/{source}/
# REMOVED in v1.101.0: enabled, dir, auto_generate (todos are always active + session-scoped)
file_todos:
  triage:
    auto_approve_p1: false
  manifest:
    auto_build: true
    dedup_on_build: false
    dedup_threshold: 0.70
  history:
    enabled: true

# ──────────────────────────────────────────────
# Forge — Forge Gaze selection overrides
# ──────────────────────────────────────────────
# Defaults are fine for this project. Uncomment to override.
# forge:
#   threshold: 0.30
#   max_per_section: 3
#   max_total_agents: 8

# ──────────────────────────────────────────────
# Plan — Verification gate patterns
# ──────────────────────────────────────────────
plan:
  verification_patterns:
    - regex: "codex auth (status|login)"
      paths: "plugins/rune/"
      expect_zero: true
      description: "No stale codex auth references (correct: codex login / codex login status)"
      phase: ["plan", "post-work"]

    - regex: "--skip-forge"
      paths: "plugins/rune/"
      exclusions: "--glob '!plugins/rune/CHANGELOG.md'"
      expect_zero: true
      description: "Flag renamed to --no-forge"
      phase: ["plan", "post-work"]

# ──────────────────────────────────────────────
# Codex Oracle — Cross-model verification (v1.18.0+)
# ──────────────────────────────────────────────
codex:
  disabled: false
  model: "gpt-5.3-codex"
  reasoning: "xhigh"
  sandbox: "read-only"
  context_budget: 20
  confidence_threshold: 80
  timeout: 600
  stream_idle_timeout: 540
  workflows: [review, audit, plan, forge, work, arc, mend, goldmask, inspect]
  work_advisory:
    enabled: true
    max_diff_size: 15000
  review_diff:
    enabled: true
    max_diff_size: 15000
    context_lines: 5
    include_new_files_full: true
  verification:
    enabled: true
    fuzzy_match_threshold: 0.7
    cross_model_bonus: 0.15
  # ── Deep Integration Keys (v1.39.0+) ──
  elicitation:
    enabled: true
    methods: []
    timeout: 300
  mend_verification:
    enabled: true
    max_diff_size: 15000
  arena:
    enabled: true
    role: "judge"
    timeout: 300
    cross_model_bonus: 0.15
  semantic_verification:
    enabled: true
    reasoning: "xhigh"
    timeout: 420
  gap_analysis:
    enabled: true
    timeout: 900
  trial_forger:
    enabled: true
    timeout: 300
    reasoning: "xhigh"
  rune_smith:
    enabled: false # Opt-in only (cost-intensive per worker per task)
    timeout: 300
    reasoning: "xhigh"
    min_diff_size: 100
    confidence_threshold: 90
  shatter:
    enabled: true
    weight: 0.3
  echo_validation:
    enabled: true
    timeout: 300
    reasoning: "xhigh"
  # ── Codex Expansion Keys (v1.87.0+) ──
  diff_verification:
    enabled: true
    timeout: 300
    reasoning: "high"
  test_coverage_critique:
    enabled: true
    timeout: 600
    reasoning: "xhigh"
  release_quality_check:
    enabled: true
    timeout: 300
    reasoning: "high"
  section_validation:
    enabled: true
    timeout: 300
    reasoning: "medium"
  research_tiebreaker:
    enabled: true
    timeout: 300
    reasoning: "high"
  task_decomposition:
    enabled: true
    timeout: 300
    reasoning: "high"
  risk_amplification:
    enabled: false # Greenfield — opt-in
    timeout: 600
    reasoning: "xhigh"
  drift_detection:
    enabled: false # Greenfield — opt-in
    timeout: 600
    reasoning: "xhigh"
  architecture_review:
    enabled: false # Audit-only niche — opt-in
    timeout: 600
    reasoning: "xhigh"
  post_monitor_critique:
    enabled: false # Post-execution signal — opt-in
    timeout: 300
    reasoning: "high"

# ──────────────────────────────────────────────
# Arc — Default flag overrides + ship/merge (v1.40.0+)
# ──────────────────────────────────────────────
# 3-layer priority: hardcoded defaults → talisman.yml → CLI flags
arc:
  # ── Phase-level timeouts in milliseconds (v1.40.0+) ──
  # Override hardcoded defaults. Clamped to 10s-1hr by arc orchestrator.
  timeouts:
    forge: 900000 # 15 min
    plan_review: 900000 # 15 min
    plan_refine: 180000 # 3 min
    verification: 30000 # 30 sec (deterministic)
    semantic_verification: 480000 # 8 min (room for 7 min codex exec + 1 min setup/cleanup)
    work: 2100000 # 35 min
    gap_analysis: 720000 # 12 min
    codex_gap_analysis: 960000 # 16 min (room for 15 min codex exec + 1 min setup/cleanup)
    gap_remediation: 900000 # 15 min
    goldmask_verification: 900000 # 15 min
    goldmask_correlation: 60000 # 1 min
    code_review: 900000 # 15 min
    mend: 1380000 # 23 min
    verify_mend: 240000 # 4 min
    test: 900000 # 15 min
    ship: 300000 # 5 min
    bot_review_wait: 900000 # 15 min (only when bot_review.enabled)
    pr_comment_resolution: 1200000 # 20 min (only when bot_review.enabled)
    merge: 600000 # 10 min

  defaults:
    no_forge: false
    approve: false
    skip_freshness: false
    confirm: false

  # ── Shard Execution (v1.66.0+) ──
  sharding:
    enabled: true
    auto_sort: true
    exclude_parent: true
    prerequisite_check: true
    shared_branch: true

  ship:
    auto_pr: true
    auto_merge: true
    merge_strategy: "squash"
    wait_ci: false
    draft: false
    labels: []
    pr_monitoring: false
    rebase_before_merge: true

  pre_merge_checks:
    migration_conflict: true
    schema_conflict: true
    lock_file_conflict: true
    uncommitted_changes: true
    migration_paths: []

  # ── Gap Analysis settings (v1.51.0+) ──
  gap_analysis:
    inspectors: 2
    halt_threshold: 50
    remediation:
      enabled: true
      max_fixes: 20
      timeout: 600000

  # ── Batch settings (v1.49.0+) ──
  batch:
    auto_merge: true
    max_retries: 3
    max_budget: 200
    max_turns: 1000
    total_budget: null
    total_timeout: null
    stop_on_divergence: false
    summaries:
      enabled: true

  # ── Cross-file consistency checks (v1.17.0+) ──
  consistency:
    checks:
      - name: version_sync
        description: "Plugin version in plugin.json must match marketplace.json"
        source:
          file: "plugins/rune/.claude-plugin/plugin.json"
          extractor: json_field
          field: "version"
        targets:
          - path: ".claude-plugin/marketplace.json"
            pattern: '"version": "{value}"'
        phase: ["plan", "post-work", "arc"]

      - name: review_agent_count
        description: "Number of review agent files must match CLAUDE.md documentation"
        source:
          file: "plugins/rune/agents/review/*.md"
          extractor: glob_count
        targets:
          - path: "plugins/rune/CLAUDE.md"
            pattern: "{value} specialized review agents"
        phase: ["plan", "post-work"]

      - name: command_count
        description: "Number of command files must match CLAUDE.md documentation"
        source:
          file: "plugins/rune/commands/*.md"
          extractor: glob_count
        targets:
          - path: "plugins/rune/CLAUDE.md"
            pattern: "{value} commands"
        phase: ["plan", "post-work"]

      - name: skill_count
        description: "Number of skill directories must match CLAUDE.md documentation"
        source:
          file: "plugins/rune/skills/*/SKILL.md"
          extractor: glob_count
        targets:
          - path: "plugins/rune/CLAUDE.md"
            pattern: "{value} skills"
        phase: ["plan", "post-work"]

# ──────────────────────────────────────────────
# Testing — Arc Phase 7.7 settings (v1.43.0+)
# ──────────────────────────────────────────────
# Documentation-only plugin — no compiled code / test suite.
# Enabled for completeness; tiers tuned for markdown/shell validation.
testing:
  enabled: true
  tiers:
    unit:
      enabled: true
      timeout_ms: 300000
      coverage: true
    integration:
      enabled: true
      timeout_ms: 300000
    e2e:
      enabled: false # No frontend — disabled
      timeout_ms: 300000
      base_url: "http://localhost:3000"
      max_routes: 3
      headed: false
  service:
    startup_command: null
    health_endpoint: null
    startup_timeout: 180000

# ──────────────────────────────────────────────
# Context Monitor — Runtime context rot prevention (v1.78.0+)
# ──────────────────────────────────────────────
context_monitor:
  enabled: true
  warning_threshold: 35
  critical_threshold: 25
  caution_threshold: 40
  stale_seconds: 60
  debounce_calls: 5
  degradation_suggestions: true
  workflows: [review, audit, work, mend, arc, devise]

# ──────────────────────────────────────────────
# Context Weaving — Unified context management
# ──────────────────────────────────────────────
context_weaving:
  glyph_budget:
    enabled: true
    word_limit: 300
    enforcement: advisory
