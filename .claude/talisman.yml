version: 1

# ──────────────────────────────────────────────
# Rune Gaze — File classification overrides
# ──────────────────────────────────────────────
rune-gaze:
  backend_extensions:
    - .py
    - .go
    - .rs
    - .rb

  frontend_extensions:
    - .tsx
    - .ts
    - .jsx

  skip_patterns:
    - "**/migrations/**"
    - "**/*.generated.ts"
    - "**/vendor/**"

  always_review:
    - "CLAUDE.md"
    - ".claude/**/*.md"

# ──────────────────────────────────────────────
# Settings — Global behavior adjustments
# ──────────────────────────────────────────────
settings:
  max_ashes: 8
  dedup_hierarchy:
    - SEC
    - BACK
    - DOC
    - QUAL
    - FRONT
    - CDX
  verification:
    layer_2_custom_agents: true

# ──────────────────────────────────────────────
# Defaults
# ──────────────────────────────────────────────
defaults:
  disable_ashes: []

# ──────────────────────────────────────────────
# Solution Arena — Competitive solution evaluation (v1.24.0+)
# ──────────────────────────────────────────────
solution_arena:
  enabled: true
  skip_for_types: ["fix"]

# ──────────────────────────────────────────────
# Elicitation — Structured reasoning agent (v1.31.0+)
# ──────────────────────────────────────────────
elicitation:
  enabled: true

# ──────────────────────────────────────────────
# Echoes — Memory persistence
# ──────────────────────────────────────────────
echoes:
  version_controlled: false

# ──────────────────────────────────────────────
# Review — Chunked review and convergence settings (v1.35.0+)
# ──────────────────────────────────────────────
review:
  chunk_threshold: 20
  chunk_target_size: 15
  max_chunks: 5
  cross_cutting_pass: true
  chunk_strategy: "directory" # RESERVED — not yet consumed
  convergence_enabled: true
  convergence_tier_override: null
  convergence_density_threshold: 0.3
  convergence_evidence_threshold: 0.7
  convergence_confidence_threshold: 0.6
  convergence_coverage_threshold: 0.4

# ──────────────────────────────────────────────
# Work — Swarm execution settings
# ──────────────────────────────────────────────
# This is a documentation-only plugin (no compiled code / test suite).
# Ward commands validate markdown structure and cross-file consistency.
work:
  # SEC: ward_commands are executed as raw shell. Changes to this file should be reviewed for command injection.
  ward_commands:
    # NOTE: This command uses Bash process substitution (<(...)). Ensure shell is Bash.
    - "echo 'ward: checking plugin.json sync' && diff <(jq -r .version plugins/rune/.claude-plugin/plugin.json) <(jq -r '.plugins[0].version' .claude-plugin/marketplace.json)"
  max_workers: 3
  approve_timeout: 180
  commit_format: "rune: {subject} [ward-checked]"
  skip_branch_check: false
  branch_prefix: "rune/work"
  pr_monitoring: false
  co_authors: []

# ──────────────────────────────────────────────
# Forge — Forge Gaze selection overrides
# ──────────────────────────────────────────────
# Defaults are fine for this project. Uncomment to override.
# forge:
#   threshold: 0.30
#   max_per_section: 3
#   max_total_agents: 8

# ──────────────────────────────────────────────
# Plan — Verification gate patterns
# ──────────────────────────────────────────────
plan:
  verification_patterns:
    # Catch stale codex auth references (the bug we just fixed in v1.18.1)
    - regex: "codex auth (status|login)"
      paths: "plugins/rune/"
      expect_zero: true
      description: "No stale codex auth references (correct: codex login / codex login status)"
      phase: ["plan", "post-work"]

    # Catch stale --skip-forge flag (renamed to --no-forge in v1.13.0)
    - regex: "--skip-forge"
      paths: "plugins/rune/"
      exclusions: "--glob '!plugins/rune/CHANGELOG.md'"
      expect_zero: true
      description: "Flag renamed to --no-forge"
      phase: ["plan", "post-work"]

# ──────────────────────────────────────────────
# Codex Oracle — Cross-model verification (v1.18.0+)
# ──────────────────────────────────────────────
codex:
  disabled: false
  model: "gpt-5.3-codex"
  reasoning: "high"
  sandbox: "read-only"
  context_budget: 20
  confidence_threshold: 80
  workflows: [review, audit, plan, forge, work]
  work_advisory:
    enabled: true
    max_diff_size: 15000
  review_diff:
    enabled: true
    max_diff_size: 15000
    context_lines: 5
    include_new_files_full: true
  verification:
    enabled: true
    fuzzy_match_threshold: 0.7
    cross_model_bonus: 0.15

# ──────────────────────────────────────────────
# Arc — Default flag overrides + ship/merge (v1.40.0+)
# ──────────────────────────────────────────────
# 3-layer priority: hardcoded defaults → talisman.yml → CLI flags
arc:
  defaults:
    no_forge: false
    approve: false
    skip_freshness: false
    confirm: false

  ship:
    auto_pr: true
    auto_merge: false
    merge_strategy: "squash"
    wait_ci: false
    draft: false
    labels: []
    pr_monitoring: false
    rebase_before_merge: true

  pre_merge_checks:
    migration_conflict: true
    schema_conflict: true
    lock_file_conflict: true
    uncommitted_changes: true
    migration_paths: []

  # ── Batch settings (v1.49.0+) ──
  batch:
    auto_merge: true
    max_retries: 3
    max_budget: 200
    max_turns: 1000
    total_budget: null
    total_timeout: null
    stop_on_divergence: false

  # ── Cross-file consistency checks (v1.17.0+) ──
  consistency:
    checks:
      # Version must match between plugin.json and marketplace.json
      - name: version_sync
        description: "Plugin version in plugin.json must match marketplace.json"
        source:
          file: "plugins/rune/.claude-plugin/plugin.json"
          extractor: json_field
          field: "version"
        targets:
          - path: ".claude-plugin/marketplace.json"
            pattern: '"version": "{value}"'
        phase: ["plan", "post-work", "arc"]

      # Review agent count (16) must match CLAUDE.md
      - name: review_agent_count
        description: "Number of review agent files must match CLAUDE.md documentation"
        source:
          file: "plugins/rune/agents/review/*.md"
          extractor: glob_count
        targets:
          - path: "plugins/rune/CLAUDE.md"
            pattern: "{value} specialized review agents"
        phase: ["plan", "post-work"]

      # Command count (13) must match CLAUDE.md
      - name: command_count
        description: "Number of command files must match CLAUDE.md documentation"
        source:
          file: "plugins/rune/commands/*.md"
          extractor: glob_count
        targets:
          - path: "plugins/rune/CLAUDE.md"
            pattern: "{value} commands"
        phase: ["plan", "post-work"]

      # Skill count (6) must match CLAUDE.md
      - name: skill_count
        description: "Number of skill directories must match CLAUDE.md documentation"
        source:
          file: "plugins/rune/skills/*/SKILL.md"
          extractor: glob_count
        targets:
          - path: "plugins/rune/CLAUDE.md"
            pattern: "{value} skills"
        phase: ["plan", "post-work"]
