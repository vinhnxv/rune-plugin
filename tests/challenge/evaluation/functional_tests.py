"""External functional tests for generated dataweaver CLI.

These tests run AGAINST the code generated by /rune:arc to verify
it actually works. They are copied into the workspace and executed
after the arc run completes.
"""

from __future__ import annotations

import json
import subprocess
from pathlib import Path

import pytest


@pytest.fixture
def tmp_data(tmp_path: Path) -> Path:
    """Create a temp directory with sample data files."""
    # Sample CSV
    csv_file = tmp_path / "people.csv"
    csv_file.write_text("name,age,city\nAlice,30,NYC\nBob,17,LA\nCharlie,25,Chicago\n")

    # Sample JSON
    json_file = tmp_path / "people.json"
    json_file.write_text(json.dumps([
        {"name": "Alice", "age": 30, "city": "NYC"},
        {"name": "Bob", "age": 17, "city": "LA"},
        {"name": "Charlie", "age": 25, "city": "Chicago"},
    ]))

    # Sample for aggregation
    sales_csv = tmp_path / "sales.csv"
    sales_csv.write_text("dept,amount\nEng,100\nEng,200\nSales,50\nSales,150\n")

    # Sample for join
    depts_csv = tmp_path / "departments.csv"
    depts_csv.write_text("dept,location\nEng,Building A\nSales,Building B\n")

    return tmp_path


def _run_dataweaver(args: list[str], cwd: Path) -> subprocess.CompletedProcess[str]:
    """Run the dataweaver CLI."""
    return subprocess.run(
        ["python", "-m", "dataweaver", *args],
        cwd=cwd,
        capture_output=True,
        text=True,
        timeout=30,
    )


class TestCLIBasics:
    """Test that the CLI responds to basic commands."""

    def test_help_output(self, tmp_data: Path) -> None:
        result = _run_dataweaver(["--help"], cwd=tmp_data)
        assert result.returncode == 0
        output = result.stdout.lower()
        assert "dataweaver" in output or "usage" in output

    def test_run_help(self, tmp_data: Path) -> None:
        result = _run_dataweaver(["run", "--help"], cwd=tmp_data)
        # Should not crash
        assert result.returncode in (0, 2)

    def test_unknown_command(self, tmp_data: Path) -> None:
        result = _run_dataweaver(["nonexistent"], cwd=tmp_data)
        assert result.returncode != 0


class TestConvert:
    """Test format conversion."""

    def test_csv_to_json(self, tmp_data: Path) -> None:
        output_file = tmp_data / "output.json"
        result = _run_dataweaver(
            ["convert", str(tmp_data / "people.csv"), str(output_file)],
            cwd=tmp_data,
        )
        assert result.returncode == 0
        assert output_file.exists()
        data = json.loads(output_file.read_text())
        assert isinstance(data, list)
        assert len(data) == 3
        assert data[0]["name"] == "Alice"


class TestInspect:
    """Test file inspection."""

    def test_inspect_csv(self, tmp_data: Path) -> None:
        result = _run_dataweaver(
            ["inspect", str(tmp_data / "people.csv")],
            cwd=tmp_data,
        )
        assert result.returncode == 0
        output = result.stdout.lower()
        # Should show column info
        assert "name" in output or "column" in output


class TestPipelineRun:
    """Test pipeline execution with transforms."""

    def test_filter_pipeline(self, tmp_data: Path) -> None:
        pipeline = tmp_data / "filter.yml"
        pipeline.write_text(
            "source:\n"
            "  path: people.csv\n"
            "  format: csv\n"
            "transforms:\n"
            "  - type: filter\n"
            "    column: age\n"
            "    operator: gte\n"
            "    value: 18\n"
            "sink:\n"
            "  path: filtered.json\n"
            "  format: json\n"
        )

        result = _run_dataweaver(["run", str(pipeline)], cwd=tmp_data)
        assert result.returncode == 0

        output_file = tmp_data / "filtered.json"
        assert output_file.exists()
        data = json.loads(output_file.read_text())
        assert len(data) == 2  # Alice (30) and Charlie (25)
        names = [d["name"] for d in data]
        assert "Bob" not in names  # Bob is 17

    def test_aggregate_pipeline(self, tmp_data: Path) -> None:
        pipeline = tmp_data / "agg.yml"
        pipeline.write_text(
            "source:\n"
            "  path: sales.csv\n"
            "  format: csv\n"
            "transforms:\n"
            "  - type: aggregate\n"
            "    group_by:\n"
            "      - dept\n"
            "    operations:\n"
            "      - column: amount\n"
            "        function: sum\n"
            "sink:\n"
            "  path: agg_output.json\n"
            "  format: json\n"
        )

        result = _run_dataweaver(["run", str(pipeline)], cwd=tmp_data)
        assert result.returncode == 0

        output_file = tmp_data / "agg_output.json"
        assert output_file.exists()
        data = json.loads(output_file.read_text())
        assert len(data) == 2

    def test_map_pipeline(self, tmp_data: Path) -> None:
        pipeline = tmp_data / "map.yml"
        pipeline.write_text(
            "source:\n"
            "  path: people.csv\n"
            "  format: csv\n"
            "transforms:\n"
            "  - type: map\n"
            "    column: name\n"
            "    function: upper\n"
            "sink:\n"
            "  path: mapped.json\n"
            "  format: json\n"
        )

        result = _run_dataweaver(["run", str(pipeline)], cwd=tmp_data)
        assert result.returncode == 0

        output_file = tmp_data / "mapped.json"
        assert output_file.exists()
        data = json.loads(output_file.read_text())
        assert data[0]["name"] == "ALICE"


class TestValidation:
    """Test pipeline validation."""

    def test_validate_missing_source(self, tmp_data: Path) -> None:
        pipeline = tmp_data / "bad.yml"
        pipeline.write_text(
            "source:\n"
            "  path: nonexistent.csv\n"
            "  format: csv\n"
            "transforms: []\n"
            "sink:\n"
            "  path: output.json\n"
            "  format: json\n"
        )

        result = _run_dataweaver(["validate", str(pipeline)], cwd=tmp_data)
        assert result.returncode != 0

    def test_dry_run(self, tmp_data: Path) -> None:
        pipeline = tmp_data / "pipeline.yml"
        pipeline.write_text(
            "source:\n"
            "  path: people.csv\n"
            "  format: csv\n"
            "transforms:\n"
            "  - type: filter\n"
            "    column: age\n"
            "    operator: gte\n"
            "    value: 18\n"
            "sink:\n"
            "  path: dry_output.json\n"
            "  format: json\n"
        )

        result = _run_dataweaver(["run", str(pipeline), "--dry-run"], cwd=tmp_data)
        assert result.returncode == 0
        # Dry run should NOT create output file
        assert not (tmp_data / "dry_output.json").exists()
